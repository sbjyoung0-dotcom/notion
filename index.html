<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM Multi-Client HQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #F8FAFC; color: #1E293B; }
        .hidden { display: none !important; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .tab-inactive:hover { color: #334155; border-bottom: 2px solid #cbd5e1; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col z-20">
        <div class="p-5 border-b border-slate-100">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="briefcase" class="text-blue-600"></i>
                PM HQ
            </h1>
            <p class="text-xs text-slate-400 mt-1">Multi-Client Management</p>
        </div>
        
        <div class="flex-1 overflow-y-auto py-4">
            <div class="px-4 mb-2 text-xs font-bold text-slate-400 uppercase">Clients</div>
            <nav id="client-nav" class="space-y-0.5 px-2">
                <!-- Client List Injected Here -->
            </nav>

            <div class="mt-6 px-4 mb-2 flex justify-between items-center">
                <span class="text-xs font-bold text-slate-400 uppercase">Upcoming Events</span>
                <button onclick="openModal('event-modal')" class="text-slate-400 hover:text-blue-600 transition-colors">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
            </div>
            <div id="event-list" class="px-2 space-y-2">
                <!-- Events Injected Here -->
            </div>
        </div>
        
        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <div class="flex items-center gap-3 mb-2">
                <div id="connection-status" class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-xs font-bold text-white">OFF</div>
                <div>
                    <p id="connection-text" class="text-sm font-bold text-slate-700">연결 중...</p>
                    <p class="text-xs text-slate-500" id="today-date"></p>
                </div>
            </div>
            <!-- Force Reset Button -->
            <button onclick="forceSeed()" class="w-full text-xs bg-red-50 text-red-600 border border-red-100 py-2 rounded hover:bg-red-100 transition flex items-center justify-center gap-1 font-medium">
                <i data-lucide="trash-2" class="w-3 h-3"></i> 전체 초기화 & 재설치
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 bg-slate-50">
        <!-- Header & Tabs -->
        <header class="bg-white border-b border-slate-200 sticky top-0 z-10">
            <div class="px-8 py-5 flex justify-between items-center">
                <div>
                    <h2 id="header-title" class="text-2xl font-bold text-slate-800">전체 현황 대시보드</h2>
                    <p id="header-desc" class="text-sm text-slate-500 mt-1">모든 고객사의 주요 이슈와 할 일을 한눈에 확인합니다.</p>
                </div>
                <div class="flex gap-2">
                    <!-- Dashboard Add Button -->
                    <button id="add-task-btn" onclick="openModal('task-modal')" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i> 새 업무
                    </button>
                    <!-- Routine Add Button (Hidden by default) -->
                    <button id="add-routine-btn" onclick="openModal('routine-modal')" class="hidden flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors shadow-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i> 루틴 추가
                    </button>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="px-8 flex gap-6">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-active pb-3 text-sm flex items-center gap-2">
                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i> 대시보드 (Tasks)
                </button>
                <button onclick="switchTab('routine')" id="tab-routine" class="tab-inactive pb-3 text-sm flex items-center gap-2">
                    <i data-lucide="repeat" class="w-4 h-4"></i> 루틴 체크 (Monthly)
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            
            <!-- VIEW 1: DASHBOARD (TASKS) -->
            <div id="view-dashboard" class="max-w-6xl mx-auto space-y-8">
                
                <!-- Quick Memo Section -->
                <section class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-yellow-800 flex items-center gap-2">
                            <i data-lucide="sticky-note" class="w-4 h-4"></i> Quick Memo (자동 저장)
                        </h3>
                        <span id="memo-status" class="text-xs text-yellow-600 font-medium"></span>
                    </div>
                    <textarea id="quick-memo" class="w-full bg-yellow-100/50 border-none rounded-lg text-sm text-slate-700 placeholder-yellow-400/70 resize-none focus:ring-2 focus:ring-yellow-400 p-2" rows="3" placeholder="급한 업무나 잊지 말아야 할 내용을 자유롭게 적으세요... (입력 후 바깥을 클릭하면 저장됩니다)"></textarea>
                </section>

                <!-- Urgent Section -->
                <section id="urgent-section" class="hidden">
                    <h3 class="text-sm font-bold text-red-600 uppercase tracking-wide mb-3 flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i> 긴급 대응 필요 (마감 임박/지연)
                    </h3>
                    <div id="urgent-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Urgent Tasks Injected Here -->
                    </div>
                </section>

                <!-- Task List -->
                <section>
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="check-square" class="w-5 h-5 text-slate-400"></i>
                            업무 리스트
                        </h3>
                        <div class="flex bg-white rounded-lg p-1 border border-slate-200 shadow-sm">
                            <button onclick="setFilter('active')" class="filter-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors bg-slate-100 text-slate-800" data-filter="active">진행중</button>
                            <button onclick="setFilter('all')" class="filter-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors text-slate-500 hover:text-slate-700" data-filter="all">전체</button>
                            <button onclick="setFilter('done')" class="filter-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors text-slate-500 hover:text-slate-700" data-filter="done">완료됨</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500 uppercase font-semibold">
                                <tr>
                                    <th class="px-6 py-4 w-12">상태</th>
                                    <th class="px-6 py-4 w-32">고객사</th>
                                    <th class="px-6 py-4">업무명 / 내용</th>
                                    <th class="px-6 py-4 w-32">마감일</th>
                                    <th class="px-6 py-4 w-24">우선순위</th>
                                    <th class="px-6 py-4 w-12"></th>
                                </tr>
                            </thead>
                            <tbody id="task-table-body" class="divide-y divide-slate-100">
                                <!-- Tasks Injected Here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- VIEW 2: ROUTINE CHECK -->
            <div id="view-routine" class="hidden max-w-5xl mx-auto space-y-6">
                <div class="flex justify-between items-center bg-blue-50 border border-blue-100 p-4 rounded-xl">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-blue-100 rounded-lg text-blue-600"><i data-lucide="calendar-clock" class="w-6 h-6"></i></div>
                        <div>
                            <h3 class="text-lg font-bold text-blue-900">월간 루틴 체크리스트</h3>
                            <p class="text-xs text-blue-700">매월 반복되는 계약/보고서 업무입니다. 주의사항을 꼭 확인하세요.</p>
                        </div>
                    </div>
                    <button onclick="resetRoutines()" class="flex items-center gap-2 px-4 py-2 bg-white border border-blue-200 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-50 transition-colors shadow-sm">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i> 새 달 시작 (초기화)
                    </button>
                </div>

                <div id="routine-list" class="space-y-4">
                    <!-- Routine Cards Injected Here -->
                </div>
            </div>

        </div>
    </main>

    <!-- Task Modal -->
    <div id="task-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">새 업무 추가</h3>
                <button onclick="closeModal('task-modal')"><i data-lucide="x" class="text-gray-400"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">고객사</label>
                    <select id="modal-client" class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">업무명</label>
                    <input type="text" id="modal-title" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="예: 12월 월간보고서 송부">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">상세 내용 (메모)</label>
                    <textarea id="modal-note" rows="3" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="업무 관련 특이사항이나 상세 내용을 입력하세요."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">우선순위</label>
                        <select id="modal-priority" class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white">
                            <option value="High">High</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">마감일</label>
                        <input type="date" id="modal-due" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                    </div>
                </div>
                <button onclick="addTask()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold mt-4 hover:bg-blue-700 transition">추가하기</button>
            </div>
        </div>
    </div>

    <!-- Routine Modal (NEW) -->
    <div id="routine-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-indigo-900">새 루틴 추가 (반복 업무)</h3>
                <button onclick="closeModal('routine-modal')"><i data-lucide="x" class="text-gray-400"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">고객사</label>
                    <select id="routine-client" class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">구분 (Type)</label>
                    <select id="routine-type" class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white">
                        <option value="Report">월간 보고 (Report)</option>
                        <option value="Contract">계약 관리 (Contract)</option>
                        <option value="System">시스템 점검 (System)</option>
                        <option value="Other">기타 (Other)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">루틴명</label>
                    <input type="text" id="routine-title" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="예: 매월 25일 CSR 마감">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">가이드/주의사항</label>
                    <textarea id="routine-guide" rows="3" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none" placeholder="이 업무를 진행할 때 주의해야 할 점 (예: OO님 참조 필수)"></textarea>
                </div>
                <button onclick="addRoutine()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold mt-4 hover:bg-indigo-700 transition">루틴 추가</button>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">새 일정 등록</h3>
                <button onclick="closeModal('event-modal')"><i data-lucide="x" class="text-gray-400"></i></button>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">일정명</label>
                    <input type="text" id="event-title" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="예: 고객사 방문 미팅">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">날짜</label>
                        <input type="date" id="event-date" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">시간</label>
                        <input type="time" id="event-time" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                    </div>
                </div>
                <button onclick="addEvent()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-bold mt-4 hover:bg-purple-700 transition">일정 추가</button>
            </div>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, updateDoc, deleteDoc, writeBatch, getDocs, query, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- USER FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCpKSQUJjxIuUD5BzCXqimJxSwQHsTV8yQ",
            authDomain: "notion-21aad.firebaseapp.com",
            projectId: "notion-21aad",
            storageBucket: "notion-21aad.firebasestorage.app",
            messagingSenderId: "573285599188",
            appId: "1:573285599188:web:6fd7721b8d9805a2037841"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let clients = [];
        let tasks = [];
        let routines = [];
        let events = [];
        let selectedClientId = 'all';
        let filterStatus = 'active';

        // --- SEED DATA (UPDATED: 2026-01-16 with IrisBright) ---
        const SEED_DATA = {
            clients: [
                { id: 'c_iris', name: '아이리스브라이트', status: 'Risk', note: '신규 제안(RFP) 진행 중' },
                { id: 'c_mizmedi', name: '미즈메디', status: 'Stable', note: '2,200만원 계약, 노후화 심각' },
                { id: 'c_kakao', name: '카카오스타일', status: 'Stable', note: 'ISMS-P/DTE/계약 완료, 보안 이슈 소명' },
                { id: 'c_helinox', name: '헬리녹스', status: 'Stable', note: '신규 담당자 입사(1/19) 대기' },
                { id: 'c_skyhigh', name: '스카이하이', status: 'Active', note: '계약변경 합의, EPM 원화 등록' },
                { id: 'c_sunwoo', name: '선우프레시', status: 'Active', note: 'SFA 이슈, MS애저 제외' },
                { id: 'c_klean', name: '깨끗한나라', status: 'Stable', note: '발주서 날인 완료, 공수 검증' },
                { id: 'c_deloitte', name: '딜로이트', status: 'Stable', note: '보안서약서 징구, 8월~7월 계약' },
                { id: 'c_xexymix', name: '젝시믹스', status: 'Active', note: '계약 날인 완료, 등기 발송' }
            ],
            tasks: [
                // 아이리스브라이트
                { id: 't_iris_proposal', clientId: 'c_iris', title: '운영제안서 제작 (16:9)', status: 'todo', due: '2026-01-19', priority: 'High', note: '오스템임플란트/GREPP 참조. 제출: 1/20 16:00 (USB 8개 직접)' },
                { id: 't_iris_profile', clientId: 'c_iris', title: '인력프로파일 정리', status: 'done', due: '', priority: 'Medium' },
                
                // 카카오스타일
                { id: 't_kakao_infra', clientId: 'c_kakao', title: '인프라/DB 권한 이슈 최종 소명', status: 'done', due: '', priority: 'High', note: 'MSS-101 계정 및 권한 사용 목적 회신 완료. (wisehre-hr, ealif 등)' },
                
                // 헬리녹스
                { id: 't_helinox_contract', clientId: 'c_helinox', title: '계약서 답변 대기 (신규담당자)', status: 'todo', due: '2026-01-22', priority: 'High', note: '1/19 입사 후 검토 -> 1/22 회신' },
                { id: 't_helinox_report', clientId: 'c_helinox', title: '12월 월간보고서 제작', status: 'done', due: '', priority: 'Low' },

                // 스카이하이
                { id: 't_sky_contract_check', clientId: 'c_skyhigh', title: '계약변경 합의서 확인', status: 'done', due: '2026-01-05', priority: 'High', note: '등기X, 스캔본 갈음 합의' },
                { id: 't_sky_report_dec', clientId: 'c_skyhigh', title: '12월 월간보고서 작성 (잔여공수)', status: 'todo', due: '', priority: 'Medium', note: '연말 잔여공수 계산하여 첨부 필수.' },

                // 선우프레시
                { id: 't_sunwoo_sfa', clientId: 'c_sunwoo', title: 'SFA 이슈 CSR 요청', status: 'todo', due: '', priority: 'High', note: '장용재 이사 -> 유경래 차장에게 내용 정리 전달 (정식 CSR 요청)' },
                { id: 't_sunwoo_report', clientId: 'c_sunwoo', title: '12월 월간보고서 제작', status: 'done', due: '', priority: 'Low' },

                // 깨끗한나라
                { id: 't_klean_claim', clientId: 'c_klean', title: '클레임 2건 공수 차감', status: 'todo', due: '', priority: 'Low', note: '오상무 자료 대기 (진행보류)' },
                { id: 't_klean_order', clientId: 'c_klean', title: '발주서 날인 및 전달', status: 'done', due: '2026-01-15', priority: 'High', note: '완료. 차기 계약은 매출과 동일하게 작성(이소담 의견)' },
                { id: 't_klean_check', clientId: 'c_klean', title: '9~11월 월간보고서 공수 검증', status: 'todo', due: '', priority: 'Medium', note: '공수 시간 재검토 필요.' },
                { id: 't_klean_visit', clientId: 'c_klean', title: '방문 보고 (4주차)', status: 'todo', due: '2026-01-27', priority: 'Medium', note: '화요일 오후 3시' },

                // 딜로이트
                { id: 't_delo_security', clientId: 'c_deloitte', title: '보안 서약서 징구 (3종)', status: 'todo', due: '', priority: 'Medium', note: '오진혁 위원 서명 -> 경영관리팀 제출' },
                { id: 't_delo_po', clientId: 'c_deloitte', title: 'PO(구매주문서) 수령 및 EPM 입력', status: 'todo', due: '', priority: 'Medium', note: '박경천 차장 협의' }
            ],
            routines: [
                { id: 'r_sky_carryover', clientId: 'c_skyhigh', type: 'Contract', title: '계약 공수 이월 체크', guide: '⚠️ 주의: 개발/CPI 파트만 이월 가능. 일반 기술지원은 절대 이월 약속 금지.' },
                { id: 'r_sky_csm', clientId: 'c_skyhigh', type: 'Report', title: '월간보고서 CSM 공수 기입', guide: 'CSM(고객지원) 공수는 8시간(1MD) 정도로 맞춰서 기입 권장.' },
                { id: 'r_helinox_fue', clientId: 'c_helinox', type: 'Report', title: '월간보고서 FUE 현황 첨부', guide: '이메일에 SAP FOR ME-consumption 캡처 첨부 필수.' },
                { id: 'r_kakao_report', clientId: 'c_kakao', type: 'Report', title: '월간보고서 작성 (3종 체크)', guide: '1. 무상공수 HR 제외\n2. CSM 공수 8시간 수기 추가\n3. CONS 건은 유지보수와 분리 작성' },
                { id: 'r_klean_report', clientId: 'c_klean', type: 'Report', title: '월간보고서 및 튜닝보고서', guide: '자동 산출 기준(수정X). 튜닝보고서 수신 시 구글드라이브 업로드 후 안내 메일.' },
                { id: 'r_klean_csr', clientId: 'c_klean', type: 'System', title: 'CSR 수정 요청', guide: '참조 필수: 김영준, 김영균 위원' },
                { id: 'r_klean_vlookup', clientId: 'c_klean', type: 'Report', title: '월간보고서 모듈별 공수 기재', guide: '담당자별 VLOOKUP으로 공수 계산하여 기재.' },
                { id: 'r_sunwoo_report', clientId: 'c_sunwoo', type: 'Report', title: '월간보고서 공수 확인', guide: 'MSP(MS애저) 공수는 CSR 계약 공수에서 제외되었는지 확인.' },
                { id: 'r_miz_rpa', clientId: 'c_mizmedi', type: 'Report', title: 'RPA 청구 및 보고서', guide: '매월 27일 데이터 수신 즉시 작성 및 청구 진행.' },
                { id: 'r_delo_report', clientId: 'c_deloitte', type: 'Report', title: '월간보고서 (BC리포트 제외)', guide: 'BC리포트는 첨부하지 않음.' },
                { id: 'r_delo_contract', clientId: 'c_deloitte', type: 'Contract', title: '계약 갱신/보안서약서', guide: '계약 갱신 시마다 보안서약서(3종) 오진혁 위원 서명 필요.' },
                { id: 'r_common_epm', clientId: 'ALL', type: 'Contract', title: '전자결재 매입 기재', guide: '매입 작성 시 [내부용역비] 항목으로 기재할 것.' },
                { id: 'r_common_ies', clientId: 'ALL', type: 'System', title: 'IES 청구 공수 검증', guide: '분기별 CSR 다운로드 후 피벗테이블로 내부 매출/청구 공수 검증.' }
            ],
            events: [
                { id: 'e_doc_check', title: '등기 수령 확인 (젝시,카카오,스카이)', date: '2026-01-06', type: 'done' },
                { id: 'e_heli_new', title: '헬리녹스 신규 담당자 입사', date: '2026-01-19', type: 'upcoming' },
                { id: 'e_iris_submit', title: '아이리스브라이트 제안서 제출', date: '2026-01-20', time: '16:00', type: 'upcoming' },
                { id: 'e_iris_pt', title: '아이리스브라이트 제안 발표', date: '2026-01-22', time: '14:30', type: 'upcoming' },
                { id: 'e_klean_visit', title: '깨끗한나라 방문 보고', date: '2026-01-27', time: '15:00', type: 'upcoming' }
            ]
        };

        // --- AUTH & INIT ---
        document.getElementById('today-date').innerText = new Date().toISOString().split('T')[0];

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('connection-status').classList.remove('bg-gray-400');
                document.getElementById('connection-status').classList.add('bg-green-500');
                document.getElementById('connection-status').innerText = "ON";
                document.getElementById('connection-text').innerText = "저장소 연결됨";
                initListeners(user.uid);
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        function initListeners(uid) {
            // Clients
            onSnapshot(collection(db, 'pm_users', uid, 'clients'), (snapshot) => {
                clients = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                // Auto seed ONLY if completely empty (Safety)
                if (snapshot.empty && !localStorage.getItem('pm_seeded_v5')) {
                    seedDatabase(uid);
                    localStorage.setItem('pm_seeded_v5', 'true');
                }
                renderClients();
                populateClientSelect();
                renderTasks();
                renderRoutines();
            });

            // Tasks
            onSnapshot(collection(db, 'pm_users', uid, 'tasks'), (snapshot) => {
                tasks = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderTasks();
                renderUrgent();
            });

            // Routines
            onSnapshot(collection(db, 'pm_users', uid, 'routines'), (snapshot) => {
                routines = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderRoutines();
            });

            // Events
            onSnapshot(collection(db, 'pm_users', uid, 'events'), (snapshot) => {
                events = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderEvents();
            });

            // Quick Memo Listener
            onSnapshot(doc(db, 'pm_users', uid, 'memos', 'quick'), (docSnap) => {
                const memoArea = document.getElementById('quick-memo');
                if (docSnap.exists()) {
                    // Only update if not currently focused to prevent cursor jumping
                    if (document.activeElement !== memoArea) {
                        memoArea.value = docSnap.data().content || '';
                    }
                }
            });
        }

        async function clearCollection(collectionPath) {
            const q = query(collection(db, collectionPath));
            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            snapshot.docs.forEach((doc) => {
                batch.delete(doc.ref);
            });
            await batch.commit();
        }

        async function seedDatabase(uid) {
            const batch = writeBatch(db);
            
            // Clients (Use fixed ID)
            for(const c of SEED_DATA.clients) {
                const ref = doc(db, 'pm_users', uid, 'clients', c.id);
                batch.set(ref, c);
            }

            // Tasks (Use fixed ID)
            for(const t of SEED_DATA.tasks) {
                const ref = doc(db, 'pm_users', uid, 'tasks', t.id);
                batch.set(ref, t);
            }

            // Routines (Use fixed ID)
            for(const r of SEED_DATA.routines) {
                const clientId = r.clientId === 'ALL' ? 'ALL' : r.clientId;
                const ref = doc(db, 'pm_users', uid, 'routines', r.id);
                batch.set(ref, { isChecked: false, ...r });
            }

            // Events (Use fixed ID)
            for(const e of SEED_DATA.events) {
                const ref = doc(db, 'pm_users', uid, 'events', e.id);
                batch.set(ref, e);
            }

            try {
                await batch.commit();
                console.log("Seeded successfully with IDEMPOTENCY");
            } catch(e) {
                console.error("Seeding Failed:", e);
                alert("초기화 실패. 콘솔을 확인하세요.");
            }
        }

        // --- GLOBAL ACTIONS ---
        window.forceSeed = async () => {
            if(!currentUser) {
                alert("서버 연결 전입니다. 잠시 후 시도하세요.");
                return;
            }
            if(confirm("⚠️ 경고: 모든 데이터를 삭제하고 '중복 없는' 초기 상태로 되돌립니다. 계속하시겠습니까?")) {
                try {
                    // Wipe everything first
                    await clearCollection(`pm_users/${currentUser.uid}/tasks`);
                    await clearCollection(`pm_users/${currentUser.uid}/routines`);
                    await clearCollection(`pm_users/${currentUser.uid}/events`);
                    await clearCollection(`pm_users/${currentUser.uid}/clients`);
                    
                    // Then Seed
                    await seedDatabase(currentUser.uid);
                    alert("전체 초기화 및 재설치 완료! 중복이 제거되었습니다.");
                } catch(e) {
                    console.error(e);
                    alert("초기화 중 오류 발생.");
                }
            }
        };

        window.switchTab = (tab) => {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-routine').classList.add('hidden');
            document.getElementById('tab-dashboard').className = 'tab-inactive pb-3 text-sm flex items-center gap-2';
            document.getElementById('tab-routine').className = 'tab-inactive pb-3 text-sm flex items-center gap-2';

            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className = 'tab-active pb-3 text-sm flex items-center gap-2';
            
            // Buttons logic
            const addTaskBtn = document.getElementById('add-task-btn');
            const addRoutineBtn = document.getElementById('add-routine-btn');
            
            if(tab === 'routine') {
                addTaskBtn.classList.add('hidden');
                addRoutineBtn.classList.remove('hidden');
            } else {
                addTaskBtn.classList.remove('hidden');
                addRoutineBtn.classList.add('hidden');
            }
        };

        // --- QUICK MEMO LOGIC ---
        const memoArea = document.getElementById('quick-memo');
        const memoStatus = document.getElementById('memo-status');

        memoArea.addEventListener('blur', async () => {
            if(!currentUser) return;
            memoStatus.innerText = '저장 중...';
            try {
                await setDoc(doc(db, 'pm_users', currentUser.uid, 'memos', 'quick'), {
                    content: memoArea.value,
                    updatedAt: new Date().toISOString()
                });
                memoStatus.innerText = '저장됨';
                setTimeout(() => memoStatus.innerText = '', 2000);
            } catch(e) {
                console.error(e);
                memoStatus.innerText = '저장 실패';
            }
        });

        // --- RENDER LOGIC ---
        function renderRoutines() {
            const list = document.getElementById('routine-list');
            list.innerHTML = '';

            // Group by Client
            const grouped = routines.reduce((acc, r) => {
                const clientName = r.clientId === 'ALL' ? '전체공통' : (clients.find(c => c.id === r.clientId)?.name || 'Unknown');
                if(!acc[clientName]) acc[clientName] = [];
                acc[clientName].push(r);
                return acc;
            }, {});

            // Sort logic: '전체공통' first, then filtered client, then others
            const clientNames = Object.keys(grouped).sort((a,b) => {
                if(a === '전체공통') return -1;
                if(b === '전체공통') return 1;
                return a.localeCompare(b);
            });

            // Filter logic inside render
            const activeGroup = selectedClientId === 'all' ? clientNames : 
                                clientNames.filter(name => {
                                    const client = clients.find(c => c.id === selectedClientId);
                                    return name === (client ? client.name : '') || name === '전체공통';
                                });

            if(activeGroup.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-slate-400">해당 고객사의 루틴 업무가 없습니다.</div>`;
                return;
            }

            activeGroup.forEach(name => {
                const groupItems = grouped[name];
                let groupHtml = `<div class="bg-white rounded-xl border border-slate-200 overflow-hidden mb-4">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 font-bold text-slate-700 flex justify-between items-center">
                        <span>${name}</span>
                        <span class="text-xs font-normal text-slate-500">${groupItems.length} Tasks</span>
                    </div>
                    <div class="divide-y divide-slate-100">`;
                
                groupItems.forEach(r => {
                    const isChecked = r.isChecked;
                    const checkColor = isChecked ? 'bg-blue-600 border-blue-600 text-white' : 'border-slate-300 text-transparent hover:border-blue-500';
                    const textStyle = isChecked ? 'text-slate-400 line-through' : 'text-slate-800 font-medium';
                    const guideBox = r.guide ? `
                        <div class="mt-2 text-xs bg-amber-50 border border-amber-100 text-amber-800 p-2 rounded flex gap-2 items-start">
                            <i data-lucide="alert-triangle" class="w-3 h-3 mt-0.5 flex-shrink-0"></i>
                            <pre class="whitespace-pre-wrap font-sans">${r.guide}</pre>
                        </div>` : '';

                    groupHtml += `
                        <div class="p-4 hover:bg-slate-50 transition-colors">
                            <div class="flex items-start gap-3">
                                <button onclick="toggleRoutine('${r.id}', ${!isChecked})" class="mt-0.5 w-5 h-5 rounded border flex items-center justify-center transition-colors ${checkColor} flex-shrink-0">
                                    <i data-lucide="check" class="w-3.5 h-3.5"></i>
                                </button>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-600">${r.type}</span>
                                        <span class="${textStyle}">${r.title}</span>
                                    </div>
                                    ${guideBox}
                                </div>
                            </div>
                        </div>
                    `;
                });
                groupHtml += `</div></div>`;
                list.innerHTML += groupHtml;
            });
            lucide.createIcons();
        }

        window.toggleRoutine = async (id, status) => {
            await updateDoc(doc(db, 'pm_users', currentUser.uid, 'routines', id), { isChecked: status });
        };

        window.resetRoutines = async () => {
            if(!confirm("새로운 달이 시작되었습니까? 모든 루틴 체크박스를 초기화합니다.")) return;
            
            const batch = writeBatch(db);
            routines.forEach(r => {
                const ref = doc(db, 'pm_users', currentUser.uid, 'routines', r.id);
                batch.update(ref, { isChecked: false });
            });
            await batch.commit();
            alert("모든 루틴이 초기화되었습니다.");
        };

        window.addRoutine = async () => {
            const clientId = document.getElementById('routine-client').value;
            const type = document.getElementById('routine-type').value;
            const title = document.getElementById('routine-title').value;
            const guide = document.getElementById('routine-guide').value;

            if(!title) return alert("루틴명을 입력하세요");

            // Generate ID manually to keep structure clean
            const newRoutineId = 'r_manual_' + Date.now();

            await setDoc(doc(db, 'pm_users', currentUser.uid, 'routines', newRoutineId), {
                id: newRoutineId, clientId, type, title, guide, isChecked: false
            });
            closeModal('routine-modal');
            document.getElementById('routine-title').value = '';
            document.getElementById('routine-guide').value = '';
        };

        // --- EXISTING UI FUNCTIONS ---
        window.setFilter = (status) => {
            filterStatus = status;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.dataset.filter === status) {
                    btn.classList.add('bg-slate-100', 'text-slate-800');
                    btn.classList.remove('text-slate-500');
                } else {
                    btn.classList.remove('bg-slate-100', 'text-slate-800');
                    btn.classList.add('text-slate-500');
                }
            });
            renderTasks();
        };

        window.setSelectedClient = (id) => {
            selectedClientId = id;
            renderClients(); // Update active state
            renderTasks();
            renderRoutines(); // Also filter routines
            
            const client = clients.find(c => c.id === id);
            if(id === 'all') {
                document.getElementById('header-title').innerText = "전체 현황 대시보드";
                document.getElementById('header-desc').innerText = "모든 고객사의 주요 이슈와 할 일을 한눈에 확인합니다.";
            } else if(client) {
                document.getElementById('header-title').innerText = client.name;
                document.getElementById('header-desc').innerText = client.note || '고객사 상세 관리';
            }
        };

        function renderClients() {
            const nav = document.getElementById('client-nav');
            nav.innerHTML = `
                <button onclick="setSelectedClient('all')" class="w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium transition-colors ${selectedClientId === 'all' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-50'}">
                    <div class="flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> 전체 보기</div>
                </button>
            `;

            // Sort clients by name
            clients.sort((a,b) => a.name.localeCompare(b.name));

            clients.forEach(c => {
                const color = c.status === 'Risk' ? 'bg-red-500' : c.status === 'Warning' ? 'bg-orange-400' : 'bg-green-400';
                const activeClass = selectedClientId === c.id ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-50';
                const alertIcon = c.status === 'Risk' ? '<i data-lucide="alert-circle" class="w-3.5 h-3.5 text-red-500"></i>' : '';
                
                nav.innerHTML += `
                    <button onclick="setSelectedClient('${c.id}')" class="w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium transition-colors ${activeClass}">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full ${color}"></span> ${c.name}
                        </div>
                        ${alertIcon}
                    </button>
                `;
            });
            lucide.createIcons();
        }

        function renderTasks() {
            const tbody = document.getElementById('task-table-body');
            tbody.innerHTML = '';
            
            const filtered = tasks.filter(t => {
                const clientMatch = selectedClientId === 'all' || t.clientId === selectedClientId;
                const statusMatch = filterStatus === 'all' ? true : 
                                    filterStatus === 'active' ? t.status !== 'done' : 
                                    t.status === filterStatus;
                return clientMatch && statusMatch;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-slate-400">해당하는 업무가 없습니다.</td></tr>`;
                return;
            }

            filtered.forEach(t => {
                const client = clients.find(c => c.id === t.clientId);
                // Handle 'ALL' client ID for Common tasks
                const clientName = t.clientId === 'ALL' ? '공통' : (client ? client.name : 'Unknown');
                
                const isDone = t.status === 'done';
                const trClass = isDone ? 'bg-slate-50/50' : 'hover:bg-slate-50';
                const titleClass = isDone ? 'text-slate-400 line-through decoration-slate-300' : 'text-slate-800';
                const checkColor = isDone ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300 hover:border-blue-500 text-transparent hover:text-blue-200';
                
                let priorityClass = 'bg-slate-100 text-slate-600';
                if(t.priority === 'High') priorityClass = 'bg-red-50 text-red-700';
                else if(t.priority === 'Medium') priorityClass = 'bg-orange-50 text-orange-700';

                tbody.innerHTML += `
                    <tr class="${trClass} transition-colors group">
                        <td class="px-6 py-4">
                            <button onclick="toggleStatus('${t.id}', '${t.status}')" class="w-5 h-5 rounded border flex items-center justify-center transition-colors ${checkColor}">
                                <i data-lucide="check" class="w-3 h-3"></i>
                            </button>
                        </td>
                        <td class="px-6 py-4 font-medium text-slate-700">${clientName}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium ${titleClass}">${t.title}</div>
                            ${t.note ? `<div class="text-xs text-slate-500 mt-1 flex items-center gap-1"><i data-lucide="file-text" class="w-3 h-3"></i> ${t.note}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 text-slate-500 font-mono text-xs">${t.due || '-'}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${priorityClass}">${t.priority}</span>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="deleteTask('${t.id}')" class="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            lucide.createIcons();
        }

        function renderUrgent() {
            const container = document.getElementById('urgent-grid');
            const section = document.getElementById('urgent-section');
            container.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            const urgent = tasks.filter(t => {
                if(t.status === 'done' || !t.due) return false;
                const days = Math.ceil((new Date(t.due) - new Date(today)) / (1000 * 60 * 60 * 24));
                return days <= 3;
            });

            if(urgent.length === 0) {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');

            urgent.forEach(t => {
                const client = clients.find(c => c.id === t.clientId);
                const clientName = t.clientId === 'ALL' ? '공통' : (client ? client.name : '-');
                const daysLeft = Math.ceil((new Date(t.due) - new Date(today)) / (1000 * 60 * 60 * 24));

                container.innerHTML += `
                    <div class="bg-red-50 border border-red-100 rounded-xl p-4 shadow-sm relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-red-100 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-bold text-red-600 bg-white px-2 py-0.5 rounded border border-red-100">${clientName}</span>
                                <span class="text-xs font-bold text-red-500">D-${daysLeft}</span>
                            </div>
                            <h4 class="font-bold text-slate-800 mb-1">${t.title}</h4>
                            ${t.note ? `<p class="text-xs text-slate-600 mb-2 bg-white/50 p-1.5 rounded">${t.note}</p>` : ''}
                            <div class="flex justify-between items-center mt-3">
                                <span class="text-xs text-slate-400 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${t.due}</span>
                                <button onclick="toggleStatus('${t.id}', '${t.status}')" class="text-xs bg-white border border-red-200 text-red-600 px-2 py-1 rounded hover:bg-red-600 hover:text-white transition-colors">완료 처리</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        function renderEvents() {
            const list = document.getElementById('event-list');
            list.innerHTML = '';
            
            const sorted = events.sort((a,b) => new Date(a.date) - new Date(b.date));
            const today = new Date().toISOString().split('T')[0];

            sorted.filter(e => new Date(e.date) >= new Date(today)).forEach(e => {
                list.innerHTML += `
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-100">
                        <div class="flex items-start gap-2">
                            <i data-lucide="calendar" class="w-3.5 h-3.5 text-purple-600 mt-0.5"></i>
                            <div>
                                <p class="text-xs font-bold text-purple-800">${e.title}</p>
                                <p class="text-xs text-purple-600 mt-0.5">${e.date} ${e.time || ''}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        function populateClientSelect() {
            const selectTask = document.getElementById('modal-client');
            const selectRoutine = document.getElementById('routine-client');
            
            const options = `<option value="ALL" class="font-bold">✨ 공통 (General)</option>` + 
                clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                
            selectTask.innerHTML = options;
            selectRoutine.innerHTML = options;
        }

        // --- ACTIONS (Attached to Window) ---
        window.toggleStatus = async (id, currentStatus) => {
            const next = currentStatus === 'done' ? 'todo' : 'done';
            await updateDoc(doc(db, 'pm_users', currentUser.uid, 'tasks', id), { status: next });
        };

        window.deleteTask = async (id) => {
            if(confirm("삭제하시겠습니까?")) {
                await deleteDoc(doc(db, 'pm_users', currentUser.uid, 'tasks', id));
            }
        };

        window.addTask = async () => {
            const clientId = document.getElementById('modal-client').value;
            const title = document.getElementById('modal-title').value;
            const note = document.getElementById('modal-note').value;
            const priority = document.getElementById('modal-priority').value;
            const due = document.getElementById('modal-due').value;

            if(!title) return alert("업무명을 입력하세요");

            await addDoc(collection(db, 'pm_users', currentUser.uid, 'tasks'), {
                clientId, title, note, priority, due, status: 'todo'
            });
            closeModal('task-modal');
            document.getElementById('modal-title').value = '';
            document.getElementById('modal-note').value = '';
        };

        window.addEvent = async () => {
            const title = document.getElementById('event-title').value;
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;

            if(!title || !date) return alert("일정명과 날짜를 입력하세요");

            await addDoc(collection(db, 'pm_users', currentUser.uid, 'events'), {
                title, date, time
            });
            closeModal('event-modal');
            document.getElementById('event-title').value = '';
        };

        // --- MODAL UTILS ---
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

    </script>
</body>
</html>
