<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM Multi-Client HQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #F8FAFC; color: #1E293B; }
        .hidden { display: none !important; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col z-20">
        <div class="p-5 border-b border-slate-100">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="briefcase" class="text-blue-600"></i>
                PM HQ
            </h1>
            <p class="text-xs text-slate-400 mt-1">Multi-Client Management</p>
        </div>
        
        <div class="flex-1 overflow-y-auto py-4">
            <div class="px-4 mb-2 text-xs font-bold text-slate-400 uppercase">Clients</div>
            <nav id="client-nav" class="space-y-0.5 px-2">
                <!-- Client List Injected Here -->
            </nav>

            <div class="mt-6 px-4 mb-2 flex justify-between items-center">
                <span class="text-xs font-bold text-slate-400 uppercase">Upcoming Events</span>
                <button onclick="openModal('event-modal')" class="text-slate-400 hover:text-blue-600 transition-colors">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
            </div>
            <div id="event-list" class="px-2 space-y-2">
                <!-- Events Injected Here -->
            </div>
        </div>
        
        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <div class="flex items-center gap-3 mb-2">
                <div id="connection-status" class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-xs font-bold text-white">OFF</div>
                <div>
                    <p id="connection-text" class="text-sm font-bold text-slate-700">연결 중...</p>
                    <p class="text-xs text-slate-500" id="today-date"></p>
                </div>
            </div>
            <!-- Force Reset Button -->
            <button onclick="forceSeed()" class="w-full text-xs bg-slate-100 text-slate-600 py-2 rounded hover:bg-slate-200 transition flex items-center justify-center gap-1">
                <i data-lucide="refresh-cw" class="w-3 h-3"></i> 데이터 초기화
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 bg-slate-50">
        <header class="bg-white border-b border-slate-200 px-8 py-5 flex justify-between items-center sticky top-0 z-10">
            <div>
                <h2 id="header-title" class="text-2xl font-bold text-slate-800">전체 현황 대시보드</h2>
                <p id="header-desc" class="text-sm text-slate-500 mt-1">모든 고객사의 주요 이슈와 할 일을 한눈에 확인합니다.</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openModal('task-modal')" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
                    <i data-lucide="plus" class="w-4 h-4"></i> 새 업무
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <div class="max-w-6xl mx-auto space-y-8">
                
                <!-- Urgent Section -->
                <section id="urgent-section" class="hidden">
                    <h3 class="text-sm font-bold text-red-600 uppercase tracking-wide mb-3 flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i> 긴급 대응 필요 (마감 임박/지연)
                    </h3>
                    <div id="urgent-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Urgent Tasks Injected Here -->
                    </div>
                </section>

                <!-- Task List -->
                <section>
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="check-square" class="w-5 h-5 text-slate-400"></i>
                            업무 리스트
                        </h3>
                        <div class="flex bg-white rounded-lg p-1 border border-slate-200 shadow-sm">
                            <button onclick="setFilter('active')" class="filter-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors bg-slate-100 text-slate-800" data-filter="active">진행중</button>
                            <button onclick="setFilter('all')" class="filter-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors text-slate-500 hover:text-slate-700" data-filter="all">전체</button>
                            <button onclick="setFilter('done')" class="filter-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors text-slate-500 hover:text-slate-700" data-filter="done">완료됨</button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500 uppercase font-semibold">
                                <tr>
                                    <th class="px-6 py-4 w-12">상태</th>
                                    <th class="px-6 py-4 w-32">고객사</th>
                                    <th class="px-6 py-4">업무명 / 내용</th>
                                    <th class="px-6 py-4 w-32">마감일</th>
                                    <th class="px-6 py-4 w-24">우선순위</th>
                                    <th class="px-6 py-4 w-12"></th>
                                </tr>
                            </thead>
                            <tbody id="task-table-body" class="divide-y divide-slate-100">
                                <!-- Tasks Injected Here -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Task Modal -->
    <div id="task-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">새 업무 추가</h3>
                <button onclick="closeModal('task-modal')"><i data-lucide="x" class="text-gray-400"></i></button>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">고객사</label>
                    <select id="modal-client" class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">업무명</label>
                    <input type="text" id="modal-title" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="예: 12월 월간보고서 송부">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">상세 내용 (메모)</label>
                    <input type="text" id="modal-note" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="특이사항 입력">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">우선순위</label>
                        <select id="modal-priority" class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white">
                            <option value="High">High</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">마감일</label>
                        <input type="date" id="modal-due" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                    </div>
                </div>
                <button onclick="addTask()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold mt-4 hover:bg-blue-700 transition">추가하기</button>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">새 일정 등록</h3>
                <button onclick="closeModal('event-modal')"><i data-lucide="x" class="text-gray-400"></i></button>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">일정명</label>
                    <input type="text" id="event-title" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="예: 고객사 방문 미팅">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">날짜</label>
                        <input type="date" id="event-date" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">시간</label>
                        <input type="time" id="event-time" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                    </div>
                </div>
                <button onclick="addEvent()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-bold mt-4 hover:bg-purple-700 transition">일정 추가</button>
            </div>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- USER FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCpKSQUJjxIuUD5BzCXqimJxSwQHsTV8yQ",
            authDomain: "notion-21aad.firebaseapp.com",
            projectId: "notion-21aad",
            storageBucket: "notion-21aad.firebasestorage.app",
            messagingSenderId: "573285599188",
            appId: "1:573285599188:web:6fd7721b8d9805a2037841"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let clients = [];
        let tasks = [];
        let events = [];
        let selectedClientId = 'all';
        let filterStatus = 'active';

        // --- SEED DATA (UPDATED: 2026-01-07) ---
        const SEED_DATA = {
            clients: [
                { name: '미즈메디', status: 'Stable', note: '2,200만원 계약, 노후화 심각' },
                { name: '카카오스타일', status: 'Risk', note: 'ISMS-P 감사 대비, 계약 체결' },
                { name: '헬리녹스', status: 'Stable', note: '신규 담당자 입사(1/19) 대기' },
                { name: '스카이하이', status: 'Active', note: '계약변경 합의, EPM 원화 등록' },
                { name: '선우프레시', status: 'Active', note: 'SFA 이슈, MS애저 제외' },
                { name: '깨끗한나라', status: 'Warning', note: '클레임 차감, 튜닝보고서 공유' },
                { name: '딜로이트', status: 'Stable', note: '보안서약서 징구, 8월~7월 계약' },
                { name: '젝시믹스', status: 'Active', note: '계약 날인 완료, 등기 발송' }
            ],
            tasks: [
                // 미즈메디
                { clientName: '미즈메디', title: '11월 월간보고서 제작', status: 'done', due: '2025-12-26', priority: 'Low', note: 'CSR 조회: 전달 27일~이달 26일' },
                { clientName: '미즈메디', title: '12월 월간보고서 제작', status: 'done', due: '2026-01-05', priority: 'Low' },
                { clientName: '미즈메디', title: 'RPA 청구 및 데이터 수신', status: 'todo', due: '2026-01-27', priority: 'High', note: '매월 27일 필수' },
                { clientName: '미즈메디', title: '정기 방문 모니터링 체크', status: 'todo', due: '', priority: 'Medium', note: '박재영 상무 수행 현황 확인' },
                { clientName: '미즈메디', title: 'MM 모듈 개발 요구 방어', status: 'in-progress', due: '', priority: 'High', note: '김종암 실장: ROI 부족 논리 대응' },

                // 카카오스타일
                { clientName: '카카오스타일', title: 'ISMS-P/감사 인터뷰 F/U', status: 'done', due: '2026-01-11', priority: 'High', note: '11일 목요일까지 F/U' },
                { clientName: '카카오스타일', title: '네트워크 구성도 파악 (DTE)', status: 'done', due: '2026-01-06', priority: 'High', note: '회신 없으면 점심쯤 확인 후 종합 결정' },
                { clientName: '카카오스타일', title: '26년 계약서 날인 및 등기', status: 'done', due: '2026-01-05', priority: 'High', note: '김서연 위원: 결재 후 퀵 발송 -> 완료' },
                { clientName: '카카오스타일', title: '[HRS] 12월 유지보수 내역', status: 'todo', due: '', priority: 'Low', note: '무상공수 HR 제외 확인' },
                { clientName: '카카오스타일', title: '[ASPN] 12월 e-HR 보고서', status: 'todo', due: '', priority: 'Low', note: 'CSM 8시간 수기 추가' },

                // 헬리녹스
                { clientName: '헬리녹스', title: '12월 월간보고서 제작', status: 'todo', due: '', priority: 'Low' },
                { clientName: '헬리녹스', title: '26년 유지보수 견적 전달', status: 'todo', due: '', priority: 'Medium' },
                { clientName: '헬리녹스', title: '계약서 답변 대기 (신규담당자)', status: 'todo', due: '2026-01-22', priority: 'High', note: '1/19 입사 후 검토 -> 1/22 회신' },

                // 스카이하이
                { clientName: '스카이하이', title: 'EPM 등록 (9,780만원)', status: 'todo', due: '', priority: 'High', note: '원화 기입 필수' },
                { clientName: '스카이하이', title: '계약변경 합의서 확인', status: 'done', due: '2026-01-05', priority: 'High', note: '등기X, 스캔본 갈음 합의' },
                { clientName: '스카이하이', title: '11월 월간보고서 (단가유지)', status: 'done', due: '', priority: 'Low', note: 'CSM 8시간(1MD) 기입' },

                // 선우프레시
                { clientName: '선우프레시', title: '26년 계약서 작성 (SLA별첨)', status: 'done', due: '', priority: 'Medium' },
                { clientName: '선우프레시', title: '세금계산서 발행 (12/29)', status: 'done', due: '2025-12-29', priority: 'Medium', note: '유경래 차장 소통 완료' },
                { clientName: '선우프레시', title: 'SFA 이슈 F/U (장용재 이사)', status: 'todo', due: '', priority: 'High' },
                { clientName: '선우프레시', title: '12월 월간보고서 제작', status: 'done', due: '', priority: 'Low', note: 'MS 애저(MSP) 공수 제외 확인' },

                // 깨끗한나라
                { clientName: '깨끗한나라', title: '재계약 협상 (2-3% 인상)', status: 'done', due: '', priority: 'High', note: '이성훈 상무' },
                { clientName: '깨끗한나라', title: '클레임 2건 공수 차감', status: 'todo', due: '', priority: 'High', note: '오상무 자료 대기' },
                { clientName: '깨끗한나라', title: '잘레시아 발주서 수령', status: 'done', due: '', priority: 'Medium', note: '견적서X 발주서O' },
                { clientName: '깨끗한나라', title: '25년 추가공수 세금계산서', status: 'done', due: '2025-12-29', priority: 'Medium' },
                { clientName: '깨끗한나라', title: '26년 계약서 협상 완료', status: 'done', due: '2026-01-05', priority: 'High' },
                { clientName: '깨끗한나라', title: '방문 보고 (4주차)', status: 'todo', due: '2026-01-27', priority: 'Medium', note: '화요일 오후 3시' },
                { clientName: '깨끗한나라', title: '튜닝보고서 공유', status: 'todo', due: '', priority: 'Low', note: '양다은 사원 수신 시 구글업로드' },

                // 딜로이트
                { clientName: '딜로이트', title: '12월 월간보고서', status: 'done', due: '', priority: 'Low', note: 'BC리포트 첨부 X' },
                { clientName: '딜로이트', title: '보안 서약서 징구 (3종)', status: 'todo', due: '', priority: 'Medium', note: '오진혁 위원 서명 -> 경영관리팀 제출' },
                { clientName: '딜로이트', title: 'PO(구매주문서) 수령 및 EPM 입력', status: 'todo', due: '', priority: 'Medium', note: '박경천 차장 협의' },

                // 젝시믹스
                { clientName: '젝시믹스', title: '26년 계약서 전자결재', status: 'done', due: '2026-01-06', priority: 'High', note: '1/5 퀵수령 -> 1/6 등기발송 완료' }
            ],
            events: [
                { title: 'SAP CX 웨비나', date: '2025-12-10', time: '16:00', type: 'done' },
                { title: '가족 초청 문화행사', date: '2025-12-12', time: '19:30', type: 'done' },
                { title: '고객초청행사', date: '2025-12-17', time: '16:30', type: 'done' },
                { title: '등기 수령 확인 (젝시,카카오,스카이)', date: '2026-01-06', type: 'done' },
                { title: '헬리녹스 신규 담당자 입사', date: '2026-01-19', type: 'upcoming' },
                { title: '깨끗한나라 방문 보고', date: '2026-01-27', time: '15:00', type: 'upcoming' }
            ]
        };

        // --- AUTH & INIT ---
        document.getElementById('today-date').innerText = new Date().toISOString().split('T')[0];

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('connection-status').classList.remove('bg-gray-400');
                document.getElementById('connection-status').classList.add('bg-green-500');
                document.getElementById('connection-status').innerText = "ON";
                document.getElementById('connection-text').innerText = "저장소 연결됨";
                initListeners(user.uid);
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        function initListeners(uid) {
            // Listen Clients
            onSnapshot(collection(db, 'pm_users', uid, 'clients'), (snapshot) => {
                const loadedClients = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                clients = loadedClients;
                
                // Seed if empty
                if (snapshot.empty && !localStorage.getItem('pm_seeded')) {
                    seedDatabase(uid);
                    localStorage.setItem('pm_seeded', 'true');
                }
                
                renderClients();
                populateClientSelect(); // For Modal
                renderTasks(); // Re-render tasks to update client names
            });

            // Listen Tasks
            onSnapshot(collection(db, 'pm_users', uid, 'tasks'), (snapshot) => {
                tasks = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderTasks();
                renderUrgent();
            });

            // Listen Events
            onSnapshot(collection(db, 'pm_users', uid, 'events'), (snapshot) => {
                events = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderEvents();
            });
        }

        async function seedDatabase(uid) {
            const batch = writeBatch(db);
            const clientMap = {};
            
            // Clients
            for(const c of SEED_DATA.clients) {
                const ref = doc(collection(db, 'pm_users', uid, 'clients'));
                batch.set(ref, c);
                clientMap[c.name] = ref.id;
            }

            // Tasks
            for(const t of SEED_DATA.tasks) {
                const clientId = clientMap[t.clientName];
                if(clientId) {
                    const ref = doc(collection(db, 'pm_users', uid, 'tasks'));
                    batch.set(ref, {
                        clientId, 
                        title: t.title, 
                        status: t.status, 
                        due: t.due, 
                        priority: t.priority,
                        note: t.note || ''
                    });
                }
            }
            // Events
            for(const e of SEED_DATA.events) {
                const ref = doc(collection(db, 'pm_users', uid, 'events'));
                batch.set(ref, e);
            }

            try {
                await batch.commit();
                console.log("Seeded successfully");
            } catch(e) {
                console.error("Seeding Failed:", e);
                alert("데이터 초기화 실패! Firebase Console에서 Rules와 Auth 설정을 확인하세요.");
            }
        }

        // --- GLOBAL ACTIONS ---
        window.forceSeed = () => {
            if(confirm("기존 데이터를 모두 지우고 초기 상태로 되돌리시겠습니까?")) {
                if(currentUser) {
                    seedDatabase(currentUser.uid);
                    alert("초기화 명령을 보냈습니다.");
                } else {
                    alert("서버 연결 전입니다. 잠시 후 다시 시도하세요.");
                }
            }
        };

        window.setFilter = (status) => {
            filterStatus = status;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.dataset.filter === status) {
                    btn.classList.add('bg-slate-100', 'text-slate-800');
                    btn.classList.remove('text-slate-500');
                } else {
                    btn.classList.remove('bg-slate-100', 'text-slate-800');
                    btn.classList.add('text-slate-500');
                }
            });
            renderTasks();
        };

        window.setSelectedClient = (id) => {
            selectedClientId = id;
            renderClients(); // Update active state
            renderTasks();
            
            const client = clients.find(c => c.id === id);
            if(id === 'all') {
                document.getElementById('header-title').innerText = "전체 현황 대시보드";
                document.getElementById('header-desc').innerText = "모든 고객사의 주요 이슈와 할 일을 한눈에 확인합니다.";
            } else if(client) {
                document.getElementById('header-title').innerText = client.name;
                document.getElementById('header-desc').innerText = client.note || '고객사 상세 관리';
            }
        };

        function renderClients() {
            const nav = document.getElementById('client-nav');
            nav.innerHTML = `
                <button onclick="setSelectedClient('all')" class="w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium transition-colors ${selectedClientId === 'all' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-50'}">
                    <div class="flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> 전체 보기</div>
                </button>
            `;

            clients.forEach(c => {
                const color = c.status === 'Risk' ? 'bg-red-500' : c.status === 'Warning' ? 'bg-orange-400' : 'bg-green-400';
                const activeClass = selectedClientId === c.id ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-50';
                const alertIcon = c.status === 'Risk' ? '<i data-lucide="alert-circle" class="w-3.5 h-3.5 text-red-500"></i>' : '';
                
                nav.innerHTML += `
                    <button onclick="setSelectedClient('${c.id}')" class="w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium transition-colors ${activeClass}">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full ${color}"></span> ${c.name}
                        </div>
                        ${alertIcon}
                    </button>
                `;
            });
            lucide.createIcons();
        }

        function renderTasks() {
            const tbody = document.getElementById('task-table-body');
            tbody.innerHTML = '';
            
            const filtered = tasks.filter(t => {
                const clientMatch = selectedClientId === 'all' || t.clientId === selectedClientId;
                const statusMatch = filterStatus === 'all' ? true : 
                                    filterStatus === 'active' ? t.status !== 'done' : 
                                    t.status === filterStatus;
                return clientMatch && statusMatch;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-slate-400">해당하는 업무가 없습니다.</td></tr>`;
                return;
            }

            filtered.forEach(t => {
                const client = clients.find(c => c.id === t.clientId);
                const clientName = client ? client.name : 'Unknown';
                const isDone = t.status === 'done';
                const trClass = isDone ? 'bg-slate-50/50' : 'hover:bg-slate-50';
                const titleClass = isDone ? 'text-slate-400 line-through decoration-slate-300' : 'text-slate-800';
                const checkColor = isDone ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300 hover:border-blue-500 text-transparent hover:text-blue-200';
                
                let priorityClass = 'bg-slate-100 text-slate-600';
                if(t.priority === 'High') priorityClass = 'bg-red-50 text-red-700';
                else if(t.priority === 'Medium') priorityClass = 'bg-orange-50 text-orange-700';

                tbody.innerHTML += `
                    <tr class="${trClass} transition-colors group">
                        <td class="px-6 py-4">
                            <button onclick="toggleStatus('${t.id}', '${t.status}')" class="w-5 h-5 rounded border flex items-center justify-center transition-colors ${checkColor}">
                                <i data-lucide="check" class="w-3 h-3"></i>
                            </button>
                        </td>
                        <td class="px-6 py-4 font-medium text-slate-700">${clientName}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium ${titleClass}">${t.title}</div>
                            ${t.note ? `<div class="text-xs text-slate-500 mt-1 flex items-center gap-1"><i data-lucide="file-text" class="w-3 h-3"></i> ${t.note}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 text-slate-500 font-mono text-xs">${t.due || '-'}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${priorityClass}">${t.priority}</span>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="deleteTask('${t.id}')" class="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            lucide.createIcons();
        }

        function renderUrgent() {
            const container = document.getElementById('urgent-grid');
            const section = document.getElementById('urgent-section');
            container.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            const urgent = tasks.filter(t => {
                if(t.status === 'done' || !t.due) return false;
                const days = Math.ceil((new Date(t.due) - new Date(today)) / (1000 * 60 * 60 * 24));
                return days <= 3;
            });

            if(urgent.length === 0) {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');

            urgent.forEach(t => {
                const client = clients.find(c => c.id === t.clientId);
                const clientName = client ? client.name : '-';
                const daysLeft = Math.ceil((new Date(t.due) - new Date(today)) / (1000 * 60 * 60 * 24));

                container.innerHTML += `
                    <div class="bg-red-50 border border-red-100 rounded-xl p-4 shadow-sm relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-red-100 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-bold text-red-600 bg-white px-2 py-0.5 rounded border border-red-100">${clientName}</span>
                                <span class="text-xs font-bold text-red-500">D-${daysLeft}</span>
                            </div>
                            <h4 class="font-bold text-slate-800 mb-1">${t.title}</h4>
                            ${t.note ? `<p class="text-xs text-slate-600 mb-2 bg-white/50 p-1.5 rounded">${t.note}</p>` : ''}
                            <div class="flex justify-between items-center mt-3">
                                <span class="text-xs text-slate-400 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${t.due}</span>
                                <button onclick="toggleStatus('${t.id}', '${t.status}')" class="text-xs bg-white border border-red-200 text-red-600 px-2 py-1 rounded hover:bg-red-600 hover:text-white transition-colors">완료 처리</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        function renderEvents() {
            const list = document.getElementById('event-list');
            list.innerHTML = '';
            
            const sorted = events.sort((a,b) => new Date(a.date) - new Date(b.date));
            const today = new Date().toISOString().split('T')[0];

            sorted.filter(e => new Date(e.date) >= new Date(today)).forEach(e => {
                list.innerHTML += `
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-100">
                        <div class="flex items-start gap-2">
                            <i data-lucide="calendar" class="w-3.5 h-3.5 text-purple-600 mt-0.5"></i>
                            <div>
                                <p class="text-xs font-bold text-purple-800">${e.title}</p>
                                <p class="text-xs text-purple-600 mt-0.5">${e.date} ${e.time || ''}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        function populateClientSelect() {
            const select = document.getElementById('modal-client');
            select.innerHTML = '';
            clients.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        }

        // --- ACTIONS (Attached to Window) ---
        window.toggleStatus = async (id, currentStatus) => {
            const next = currentStatus === 'done' ? 'todo' : 'done';
            await updateDoc(doc(db, 'pm_users', currentUser.uid, 'tasks', id), { status: next });
        };

        window.deleteTask = async (id) => {
            if(confirm("삭제하시겠습니까?")) {
                await deleteDoc(doc(db, 'pm_users', currentUser.uid, 'tasks', id));
            }
        };

        window.addTask = async () => {
            const clientId = document.getElementById('modal-client').value;
            const title = document.getElementById('modal-title').value;
            const note = document.getElementById('modal-note').value;
            const priority = document.getElementById('modal-priority').value;
            const due = document.getElementById('modal-due').value;

            if(!title) return alert("업무명을 입력하세요");

            await addDoc(collection(db, 'pm_users', currentUser.uid, 'tasks'), {
                clientId, title, note, priority, due, status: 'todo'
            });
            closeModal('task-modal');
            document.getElementById('modal-title').value = '';
            document.getElementById('modal-note').value = '';
        };

        window.addEvent = async () => {
            const title = document.getElementById('event-title').value;
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;

            if(!title || !date) return alert("일정명과 날짜를 입력하세요");

            await addDoc(collection(db, 'pm_users', currentUser.uid, 'events'), {
                title, date, time
            });
            closeModal('event-modal');
            document.getElementById('event-title').value = '';
        };

        // --- MODAL UTILS ---
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

    </script>
</body>
</html>
