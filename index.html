<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PM Multi-Client HQ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #F8FAFC; color: #1E293B; }
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .tab-inactive:hover { color: #334155; border-bottom: 2px solid #cbd5e1; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col z-20">
        <div class="p-5 border-b border-slate-100">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="briefcase" class="text-blue-600"></i>
                PM HQ
            </h1>
            <p class="text-xs text-slate-400 mt-1">Multi-Client Management</p>
        </div>
        
        <div class="flex-1 overflow-y-auto py-4">
            <div class="px-4 mb-2 text-xs font-bold text-slate-400 uppercase">Clients</div>
            <nav id="client-nav" class="space-y-0.5 px-2">
            </nav>

            <div class="mt-6 px-4 mb-2 flex justify-between items-center">
                <span class="text-xs font-bold text-slate-400 uppercase">Upcoming Events</span>
                <button onclick="openModal('event-modal')" class="text-slate-400 hover:text-blue-600 transition-colors">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
            </div>
            <div id="event-list" class="px-2 space-y-2">
            </div>
        </div>
        
        <div class="p-4 border-t border-slate-100 bg-slate-50">
            <div class="flex items-center gap-3 mb-2">
                <div id="connection-status" class="w-8 h-8 rounded-full bg-gray-400 flex items-center justify-center text-xs font-bold text-white">OFF</div>
                <div>
                    <p id="connection-text" class="text-sm font-bold text-slate-700">연결 중...</p>
                    <p class="text-xs text-slate-500" id="today-date"></p>
                </div>
            </div>
            <button onclick="forceSeed()" class="w-full text-xs bg-red-50 text-red-600 border border-red-100 py-2 rounded hover:bg-red-100 transition flex items-center justify-center gap-1 font-medium">
                <i data-lucide="trash-2" class="w-3 h-3"></i> 전체 초기화 & 재설치
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-slate-50">
        <header class="bg-white border-b border-slate-200 sticky top-0 z-10">
            <div class="px-8 py-5 flex justify-between items-center">
                <div>
                    <h2 id="header-title" class="text-2xl font-bold text-slate-800">전체 현황 대시보드</h2>
                    <p id="header-desc" class="text-sm text-slate-500 mt-1">모든 고객사의 주요 이슈와 할 일을 한눈에 확인합니다.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="openDailyModal()" class="flex items-center gap-2 px-4 py-2 bg-rose-500 text-white rounded-lg text-sm font-medium hover:bg-rose-600 transition-colors shadow-sm">
                        <i data-lucide="sun" class="w-4 h-4"></i> 데일리 보고
                    </button>
                    <button onclick="openModal('report-modal')" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 transition-colors shadow-sm">
                        <i data-lucide="file-output" class="w-4 h-4"></i> 월간 리포트
                    </button>
                    <button onclick="openBulkModal()" class="flex items-center gap-2 px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700 transition-colors shadow-sm">
                        <i data-lucide="bot" class="w-4 h-4"></i> AI 일괄 파싱
                    </button>
                    <button id="add-task-btn" onclick="openAddTaskModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i> 새 업무
                    </button>
                    <button id="add-routine-btn" onclick="openModal('routine-modal')" class="hidden flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors shadow-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i> 루틴 추가
                    </button>
                </div>
            </div>
            
            <div class="px-8 flex gap-6">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-active pb-3 text-sm flex items-center gap-2">
                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i> 대시보드 (Tasks)
                </button>
                <button onclick="switchTab('routine')" id="tab-routine" class="tab-inactive pb-3 text-sm flex items-center gap-2">
                    <i data-lucide="repeat" class="w-4 h-4"></i> 루틴 체크 (Monthly)
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <div id="view-dashboard" class="max-w-6xl mx-auto space-y-8">
                <section class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-yellow-800 flex items-center gap-2">
                            <i data-lucide="sticky-note" class="w-4 h-4"></i> Quick Memo (자동 저장)
                        </h3>
                        <span id="memo-status" class="text-xs text-yellow-600 font-medium"></span>
                    </div>
                    <textarea id="quick-memo" class="w-full bg-yellow-100/50 border-none rounded-lg text-sm text-slate-700 placeholder-yellow-400/70 resize-none focus:ring-2 focus:ring-yellow-400 p-2" rows="3" placeholder="급한 업무나 잊지 말아야 할 내용을 자유롭게 적으세요... (입력 후 바깥을 클릭하면 저장됩니다)"></textarea>
                </section>

                <section id="urgent-section" class="hidden">
                    <h3 class="text-sm font-bold text-red-600 uppercase tracking-wide mb-3 flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i> 긴급 대응 필요 (마감 임박/지연)
                    </h3>
                    <div id="urgent-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    </div>
                </section>

                <section>
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i data-lucide="check-square" class="w-5 h-5 text-slate-400"></i>
                            업무 리스트
                        </h3>
                        <div class="flex items-center gap-2">
                            <input type="text" id="search-input" onkeyup="renderTasks()" placeholder="업무명 또는 내용 검색..." class="border border-slate-200 rounded-lg px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64 shadow-sm">
                            <div class="flex bg-white rounded-lg p-1 border border-slate-200 shadow-sm">
                                <button onclick="setFilter('active')" class="filter-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors bg-slate-100 text-slate-800" data-filter="active">진행중</button>
                                <button onclick="setFilter('all')" class="filter-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors text-slate-500 hover:text-slate-700" data-filter="all">전체</button>
                                <button onclick="setFilter('done')" class="filter-btn px-3 py-1.5 text-xs font-medium rounded-md transition-colors text-slate-500 hover:text-slate-700" data-filter="done">완료됨</button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500 uppercase font-semibold">
                                <tr>
                                    <th class="px-6 py-4 w-12">상태</th>
                                    <th class="px-6 py-4 w-32">고객사</th>
                                    <th class="px-6 py-4">업무명 / 내용</th>
                                    <th class="px-6 py-4 w-32">마감일</th>
                                    <th class="px-6 py-4 w-24">우선순위</th>
                                    <th class="px-6 py-4 w-24 text-right">관리</th>
                                </tr>
                            </thead>
                            <tbody id="task-table-body" class="divide-y divide-slate-100">
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="view-routine" class="hidden max-w-5xl mx-auto space-y-6">
                <div class="flex justify-between items-center bg-blue-50 border border-blue-100 p-4 rounded-xl">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-blue-100 rounded-lg text-blue-600"><i data-lucide="calendar-clock" class="w-6 h-6"></i></div>
                        <div>
                            <h3 class="text-lg font-bold text-blue-900">월간 루틴 체크리스트</h3>
                            <p class="text-xs text-blue-700">매월 반복되는 계약/보고서 업무입니다. 주의사항을 꼭 확인하세요.</p>
                        </div>
                    </div>
                    <button onclick="resetRoutines()" class="flex items-center gap-2 px-4 py-2 bg-white border border-blue-200 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-50 transition-colors shadow-sm">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i> 새 달 시작 (초기화)
                    </button>
                </div>

                <div id="routine-list" class="space-y-4">
                </div>
            </div>
        </div>
    </main>

    <div id="task-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold" id="task-modal-title">새 업무 추가</h3>
                <button onclick="closeModal('task-modal')"><i data-lucide="x" class="text-gray-400"></i></button>
            </div>
            <input type="hidden" id="modal-task-id">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">고객사</label>
                    <select id="modal-client" class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">업무명</label>
                    <input type="text" id="modal-title" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="예: 12월 월간보고서 송부">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">상세 내용 (메모)</label>
                    <textarea id="modal-note" rows="3" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="업무 관련 특이사항이나 상세 내용을 입력하세요."></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">우선순위</label>
                        <select id="modal-priority" class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white">
                            <option value="High">High</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">마감일</label>
                        <input type="date" id="modal-due" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                    </div>
                </div>
                <button onclick="saveTask()" id="modal-save-btn" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold mt-4 hover:bg-blue-700 transition">저장하기</button>
            </div>
        </div>
    </div>

    <div id="routine-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-indigo-900">새 루틴 추가 (반복 업무)</h3>
                <button onclick="closeModal('routine-modal')"><i data-lucide="x" class="text-gray-400"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">고객사</label>
                    <select id="routine-client" class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">구분 (Type)</label>
                    <select id="routine-type" class="w-full border border-gray-300 rounded-lg p-2 text-sm bg-white">
                        <option value="Report">월간 보고 (Report)</option>
                        <option value="Contract">계약 관리 (Contract)</option>
                        <option value="System">시스템 점검 (System)</option>
                        <option value="Other">기타 (Other)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">루틴명</label>
                    <input type="text" id="routine-title" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="예: 매월 25일 CSR 마감">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">가이드/주의사항</label>
                    <textarea id="routine-guide" rows="3" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none" placeholder="이 업무를 진행할 때 주의해야 할 점 (예: OO님 참조 필수)"></textarea>
                </div>
                <button onclick="addRoutine()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold mt-4 hover:bg-indigo-700 transition">루틴 추가</button>
            </div>
        </div>
    </div>

    <div id="event-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">새 일정 등록 (캘린더 연동)</h3>
                <button onclick="closeModal('event-modal')"><i data-lucide="x" class="text-gray-400"></i></button>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">일정명</label>
                    <input type="text" id="event-title" class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="예: 고객사 방문 미팅">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">날짜</label>
                        <input type="date" id="event-date" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">시간</label>
                        <input type="time" id="event-time" class="w-full border border-gray-300 rounded-lg p-2 text-sm">
                    </div>
                </div>
                <button onclick="addEvent()" id="btn-add-event" class="w-full bg-purple-600 text-white py-2 rounded-lg font-bold mt-4 hover:bg-purple-700 transition flex justify-center items-center gap-2">
                    일정 및 캘린더 등록
                </button>
            </div>
        </div>
    </div>

    <div id="report-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl p-6 h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0 border-b border-slate-100 pb-4">
                <h3 class="text-xl font-extrabold flex items-center gap-2 text-slate-800">
                    <i data-lucide="sparkles" class="text-purple-600 w-6 h-6"></i> 통합 월간 리포트 (AI)
                </h3>
                <button onclick="closeModal('report-modal')" class="hover:bg-slate-100 p-1 rounded transition-colors"><i data-lucide="x" class="text-gray-400"></i></button>
            </div>
            
            <div class="flex gap-3 mb-6 flex-shrink-0 bg-slate-50 p-4 rounded-lg border border-slate-200">
                <div class="flex items-center gap-2">
                    <i data-lucide="calendar-days" class="w-5 h-5 text-slate-500"></i>
                    <input type="month" id="report-month" class="border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <button onclick="createReport()" id="btn-create-report" class="bg-purple-600 text-white px-5 py-2 rounded-md text-sm font-bold hover:bg-purple-700 transition-colors flex items-center gap-2 shadow-sm">
                    <i data-lucide="file-output" class="w-4 h-4"></i> 보고서 생성
                </button>
            </div>

            <div id="report-result" class="flex-1 bg-slate-100/50 border border-slate-200 rounded-lg p-6 overflow-y-auto text-sm text-slate-700">
                <div class="flex flex-col items-center justify-center h-full text-slate-400">
                    <i data-lucide="bot" class="w-12 h-12 mb-3 text-slate-300"></i>
                    <p class="font-medium text-base">생성할 월을 선택하고 버튼을 누르세요.</p>
                    <p class="text-xs mt-1">완료된 업무 목록을 기반으로 Gemini가 초안을 작성합니다.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="bulk-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="bot" class="text-emerald-600"></i> AI 업무 일괄 파싱 및 등록
                </h3>
                <button onclick="closeModal('bulk-modal')"><i data-lucide="x" class="text-gray-400"></i></button>
            </div>
            
            <div class="flex flex-col gap-2 mb-4 flex-shrink-0">
                <textarea id="bulk-input-text" rows="4" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-emerald-500 outline-none resize-none" placeholder="이메일 본문, 회의록, 메신저 대화 내용을 통째로 붙여넣으세요..."></textarea>
                <button onclick="parseTextWithAI()" id="btn-parse-ai" class="bg-slate-800 text-white py-2 rounded-lg text-sm font-bold hover:bg-slate-700 transition flex justify-center items-center gap-2">
                    <i data-lucide="wand-2" class="w-4 h-4"></i> 텍스트 분석 시작
                </button>
            </div>

            <div id="bulk-preview-area" class="flex-1 bg-slate-50 border border-slate-200 rounded-lg p-4 overflow-y-auto space-y-3">
                <div class="h-full flex items-center justify-center text-slate-400 text-sm">
                    텍스트를 붙여넣고 분석을 시작하면, 확인 및 수정 가능한 목록이 여기에 표시됩니다.
                </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-slate-100 flex justify-end flex-shrink-0">
                <button onclick="saveBulkTasks()" id="btn-save-bulk" class="hidden bg-emerald-600 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition">
                    선택된 업무 DB 등록
                </button>
            </div>
        </div>
    </div>

    <div id="daily-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl p-6 h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0 border-b border-slate-100 pb-4">
                <h3 class="text-xl font-extrabold flex items-center gap-2 text-slate-800">
                    <i data-lucide="sun" class="text-rose-500 w-6 h-6"></i> 데일리 미팅 보고 (AI)
                </h3>
                <button onclick="closeModal('daily-modal')" class="hover:bg-slate-100 p-1 rounded transition-colors"><i data-lucide="x" class="text-gray-400"></i></button>
            </div>
            
            <div class="flex gap-3 mb-6 flex-shrink-0 bg-slate-50 p-4 rounded-lg border border-slate-200">
                <div class="flex items-center gap-2">
                    <i data-lucide="calendar" class="w-5 h-5 text-slate-500"></i>
                    <input type="date" id="daily-date" class="border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-rose-500 outline-none">
                </div>
                <button onclick="createDailyReport()" id="btn-create-daily" class="bg-rose-500 text-white px-5 py-2 rounded-md text-sm font-bold hover:bg-rose-600 transition-colors flex items-center gap-2 shadow-sm">
                    <i data-lucide="file-output" class="w-4 h-4"></i> 생성하기
                </button>
            </div>

            <div id="daily-result" class="flex-1 bg-slate-100/50 border border-slate-200 rounded-lg p-6 overflow-y-auto text-sm text-slate-700">
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, updateDoc, deleteDoc, writeBatch, getDocs, query } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCpKSQUJjxIuUD5BzCXqimJxSwQHsTV8yQ",
            authDomain: "notion-21aad.firebaseapp.com",
            projectId: "notion-21aad",
            storageBucket: "notion-21aad.firebasestorage.app",
            messagingSenderId: "573285599188",
            appId: "1:573285599188:web:6fd7721b8d9805a2037841"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app, 'us-central1');

        let currentUser = null;
        let clients = [];
        let tasks = [];
        let routines = [];
        let events = [];
        let selectedClientId = 'all';
        let filterStatus = 'active';

        const SEED_DATA = {
            clients: [
                { id: 'c_mizmedi', name: '미즈메디', status: 'Stable', note: '2,200만원 계약, 노후화 심각' },
                { id: 'c_kakao', name: '카카오스타일', status: 'Stable', note: 'ISMS-P/DTE/계약 완료, 보안 이슈 소명' },
                { id: 'c_helinox', name: '헬리녹스', status: 'Stable', note: '신규 담당자 입사(1/19) 대기' },
                { id: 'c_skyhigh', name: '스카이하이', status: 'Active', note: '계약변경 합의, EPM 원화 등록' },
                { id: 'c_sunwoo', name: '선우프레시', status: 'Active', note: 'SFA 이슈, MS애저 제외' },
                { id: 'c_klean', name: '깨끗한나라', status: 'Stable', note: '발주서 날인 완료, 공수 검증' },
                { id: 'c_deloitte', name: '딜로이트', status: 'Stable', note: '보안서약서 징구, 8월~7월 계약' },
                { id: 'c_xexymix', name: '젝시믹스', status: 'Active', note: '계약 날인 완료, 등기 발송' }
            ],
            tasks: [
                { id: 't_kakao_infra', clientId: 'c_kakao', title: '인프라/DB 권한 이슈 최종 소명', status: 'done', startDate: '2026-01-10', due: '', priority: 'High', note: 'MSS-101 계정 및 권한 사용 목적 회신 완료.', createdAt: new Date().toISOString(), completedAt: new Date().toISOString() },
                { id: 't_helinox_contract', clientId: 'c_helinox', title: '계약서 답변 대기 (신규담당자)', status: 'todo', startDate: '2026-01-18', due: '2026-01-22', priority: 'High', note: '1/19 입사 후 검토 -> 1/22 회신', createdAt: new Date().toISOString() },
                { id: 't_helinox_report', clientId: 'c_helinox', title: '12월 월간보고서 제작', status: 'done', startDate: '', due: '', priority: 'Low', createdAt: new Date().toISOString(), completedAt: new Date().toISOString() },
                { id: 't_sky_contract_check', clientId: 'c_skyhigh', title: '계약변경 합의서 확인', status: 'done', startDate: '2026-01-02', due: '2026-01-05', priority: 'High', note: '등기X, 스캔본 갈음 합의', createdAt: new Date().toISOString(), completedAt: new Date().toISOString() }
            ],
            routines: [
                { id: 'r_sky_carryover', clientId: 'c_skyhigh', type: 'Contract', title: '계약 공수 이월 체크', guide: '주의: 개발/CPI 파트만 이월 가능.' },
                { id: 'r_kakao_report', clientId: 'c_kakao', type: 'Report', title: '월간보고서 작성 (3종 체크)', guide: 'CSM 공수 8시간 수기 추가' }
            ],
            events: [
                { id: 'e_doc_check', title: '등기 수령 확인 (젝시,카카오,스카이)', date: '2026-01-06', type: 'done' },
                { id: 'e_heli_new', title: '헬리녹스 신규 담당자 입사', date: '2026-01-19', type: 'upcoming' }
            ]
        };

        const todayStr = new Date().toISOString().split('T')[0];
        document.getElementById('today-date').innerText = todayStr;
        document.getElementById('report-month').value = todayStr.substring(0, 7);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('connection-status').classList.remove('bg-gray-400');
                document.getElementById('connection-status').classList.add('bg-green-500');
                document.getElementById('connection-status').innerText = "ON";
                document.getElementById('connection-text').innerText = "저장소 연결됨";
                initListeners(user.uid);
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        function initListeners(uid) {
            onSnapshot(collection(db, 'pm_users', uid, 'clients'), (snapshot) => {
                clients = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                if (snapshot.empty && !localStorage.getItem('pm_seeded_v5')) {
                    seedDatabase(uid);
                    localStorage.setItem('pm_seeded_v5', 'true');
                }
                renderClients();
                populateClientSelect();
                renderTasks();
                renderRoutines();
            });

            onSnapshot(collection(db, 'pm_users', uid, 'tasks'), (snapshot) => {
                tasks = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderTasks();
                renderUrgent();
            });

            onSnapshot(collection(db, 'pm_users', uid, 'routines'), (snapshot) => {
                routines = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderRoutines();
            });

            onSnapshot(collection(db, 'pm_users', uid, 'events'), (snapshot) => {
                events = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderEvents();
            });

            onSnapshot(doc(db, 'pm_users', uid, 'memos', 'quick'), (docSnap) => {
                const memoArea = document.getElementById('quick-memo');
                if (docSnap.exists() && document.activeElement !== memoArea) {
                    memoArea.value = docSnap.data().content || '';
                }
            });
        }

        async function clearCollection(collectionPath) {
            const q = query(collection(db, collectionPath));
            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            snapshot.docs.forEach((doc) => batch.delete(doc.ref));
            await batch.commit();
        }

        async function seedDatabase(uid) {
            const batch = writeBatch(db);
            for(const c of SEED_DATA.clients) { batch.set(doc(db, 'pm_users', uid, 'clients', c.id), c); }
            for(const t of SEED_DATA.tasks) { batch.set(doc(db, 'pm_users', uid, 'tasks', t.id), t); }
            for(const r of SEED_DATA.routines) { batch.set(doc(db, 'pm_users', uid, 'routines', r.id), { isChecked: false, ...r }); }
            for(const e of SEED_DATA.events) { batch.set(doc(db, 'pm_users', uid, 'events', e.id), e); }

            try { await batch.commit(); } 
            catch(e) { console.error("Seeding Failed:", e); }
        }

        window.forceSeed = async () => {
            if(!currentUser) return;
            if(confirm("모든 데이터를 초기화하시겠습니까?")) {
                try {
                    await clearCollection(`pm_users/${currentUser.uid}/tasks`);
                    await clearCollection(`pm_users/${currentUser.uid}/routines`);
                    await clearCollection(`pm_users/${currentUser.uid}/events`);
                    await clearCollection(`pm_users/${currentUser.uid}/clients`);
                    await seedDatabase(currentUser.uid);
                    alert("초기화 완료");
                } catch(e) { console.error(e); }
            }
        };

        window.switchTab = (tab) => {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-routine').classList.add('hidden');
            document.getElementById('tab-dashboard').className = 'tab-inactive pb-3 text-sm flex items-center gap-2';
            document.getElementById('tab-routine').className = 'tab-inactive pb-3 text-sm flex items-center gap-2';

            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className = 'tab-active pb-3 text-sm flex items-center gap-2';
            
            const addTaskBtn = document.getElementById('add-task-btn');
            const addRoutineBtn = document.getElementById('add-routine-btn');
            
            if(tab === 'routine') {
                addTaskBtn.classList.add('hidden');
                addRoutineBtn.classList.remove('hidden');
            } else {
                addTaskBtn.classList.remove('hidden');
                addRoutineBtn.classList.add('hidden');
            }
        };

        const memoArea = document.getElementById('quick-memo');
        const memoStatus = document.getElementById('memo-status');

        memoArea.addEventListener('blur', async () => {
            if(!currentUser) return;
            memoStatus.innerText = '저장 중...';
            try {
                await setDoc(doc(db, 'pm_users', currentUser.uid, 'memos', 'quick'), {
                    content: memoArea.value,
                    updatedAt: new Date().toISOString()
                });
                memoStatus.innerText = '저장됨';
                setTimeout(() => memoStatus.innerText = '', 2000);
            } catch(e) { memoStatus.innerText = '저장 실패'; }
        });

        function renderRoutines() {
            const list = document.getElementById('routine-list');
            list.innerHTML = '';

            const grouped = routines.reduce((acc, r) => {
                const clientName = r.clientId === 'ALL' ? '전체공통' : (clients.find(c => c.id === r.clientId)?.name || 'Unknown');
                if(!acc[clientName]) acc[clientName] = [];
                acc[clientName].push(r);
                return acc;
            }, {});

            const clientNames = Object.keys(grouped).sort((a,b) => {
                if(a === '전체공통') return -1;
                if(b === '전체공통') return 1;
                return a.localeCompare(b);
            });

            const activeGroup = selectedClientId === 'all' ? clientNames : 
                                clientNames.filter(name => {
                                    const client = clients.find(c => c.id === selectedClientId);
                                    return name === (client ? client.name : '') || name === '전체공통';
                                });

            if(activeGroup.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-slate-400">루틴 업무가 없습니다.</div>`;
                return;
            }

            activeGroup.forEach(name => {
                const groupItems = grouped[name];
                let groupHtml = `<div class="bg-white rounded-xl border border-slate-200 overflow-hidden mb-4">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200 font-bold text-slate-700 flex justify-between items-center">
                        <span>${name}</span>
                        <span class="text-xs font-normal text-slate-500">${groupItems.length} Tasks</span>
                    </div>
                    <div class="divide-y divide-slate-100">`;
                
                groupItems.forEach(r => {
                    const isChecked = r.isChecked;
                    const checkColor = isChecked ? 'bg-blue-600 border-blue-600 text-white' : 'border-slate-300 text-transparent hover:border-blue-500';
                    const textStyle = isChecked ? 'text-slate-400 line-through' : 'text-slate-800 font-medium';
                    const guideBox = r.guide ? `<div class="mt-2 text-xs bg-amber-50 border border-amber-100 text-amber-800 p-2 rounded flex gap-2 items-start"><i data-lucide="alert-triangle" class="w-3 h-3 mt-0.5 flex-shrink-0"></i><pre class="whitespace-pre-wrap font-sans">${r.guide}</pre></div>` : '';

                    groupHtml += `
                        <div class="p-4 hover:bg-slate-50 transition-colors">
                            <div class="flex items-start gap-3">
                                <button onclick="toggleRoutine('${r.id}', ${!isChecked})" class="mt-0.5 w-5 h-5 rounded border flex items-center justify-center transition-colors ${checkColor} flex-shrink-0">
                                    <i data-lucide="check" class="w-3.5 h-3.5"></i>
                                </button>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-bold px-1.5 py-0.5 rounded bg-slate-100 text-slate-600">${r.type}</span>
                                        <span class="${textStyle}">${r.title}</span>
                                    </div>
                                    ${guideBox}
                                </div>
                            </div>
                        </div>
                    `;
                });
                groupHtml += `</div></div>`;
                list.innerHTML += groupHtml;
            });
            lucide.createIcons();
        }

        window.toggleRoutine = async (id, status) => {
            await updateDoc(doc(db, 'pm_users', currentUser.uid, 'routines', id), { isChecked: status });
        };

        window.resetRoutines = async () => {
            if(!confirm("모든 루틴 체크박스를 초기화합니다.")) return;
            const batch = writeBatch(db);
            routines.forEach(r => {
                const ref = doc(db, 'pm_users', currentUser.uid, 'routines', r.id);
                batch.update(ref, { isChecked: false });
            });
            await batch.commit();
        };

        window.addRoutine = async () => {
            const clientId = document.getElementById('routine-client').value;
            const type = document.getElementById('routine-type').value;
            const title = document.getElementById('routine-title').value;
            const guide = document.getElementById('routine-guide').value;

            if(!title) return alert("루틴명을 입력하세요");
            const newRoutineId = 'r_manual_' + Date.now();
            await setDoc(doc(db, 'pm_users', currentUser.uid, 'routines', newRoutineId), {
                id: newRoutineId, clientId, type, title, guide, isChecked: false
            });
            closeModal('routine-modal');
            document.getElementById('routine-title').value = '';
            document.getElementById('routine-guide').value = '';
        };

        window.setFilter = (status) => {
            filterStatus = status;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.dataset.filter === status) {
                    btn.classList.add('bg-slate-100', 'text-slate-800');
                    btn.classList.remove('text-slate-500');
                } else {
                    btn.classList.remove('bg-slate-100', 'text-slate-800');
                    btn.classList.add('text-slate-500');
                }
            });
            renderTasks();
        };

        window.setSelectedClient = (id) => {
            selectedClientId = id;
            renderClients();
            renderTasks();
            renderRoutines();
            
            const client = clients.find(c => c.id === id);
            if(id === 'all') {
                document.getElementById('header-title').innerText = "전체 현황 대시보드";
                document.getElementById('header-desc').innerText = "모든 고객사의 주요 이슈와 할 일을 한눈에 확인합니다.";
            } else if(client) {
                document.getElementById('header-title').innerText = client.name;
                document.getElementById('header-desc').innerText = client.note || '고객사 상세 관리';
            }
        };

        function renderClients() {
            const nav = document.getElementById('client-nav');
            nav.innerHTML = `
                <button onclick="setSelectedClient('all')" class="w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium transition-colors ${selectedClientId === 'all' ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-50'}">
                    <div class="flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> 전체 보기</div>
                </button>
            `;
            clients.sort((a,b) => a.name.localeCompare(b.name));
            clients.forEach(c => {
                const color = c.status === 'Risk' ? 'bg-red-500' : c.status === 'Warning' ? 'bg-orange-400' : 'bg-green-400';
                const activeClass = selectedClientId === c.id ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-50';
                const alertIcon = c.status === 'Risk' ? '<i data-lucide="alert-circle" class="w-3.5 h-3.5 text-red-500"></i>' : '';
                nav.innerHTML += `
                    <button onclick="setSelectedClient('${c.id}')" class="w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm font-medium transition-colors ${activeClass}">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full ${color}"></span> ${c.name}
                        </div>
                        ${alertIcon}
                    </button>
                `;
            });
            lucide.createIcons();
        }

        window.renderTasks = () => {
            const tbody = document.getElementById('task-table-body');
            tbody.innerHTML = '';
            
            const searchQuery = document.getElementById('search-input').value.toLowerCase();

            const filtered = tasks.filter(t => {
                const clientMatch = selectedClientId === 'all' || t.clientId === selectedClientId;
                const statusMatch = filterStatus === 'all' ? true : 
                                    filterStatus === 'active' ? t.status !== 'done' : 
                                    t.status === filterStatus;
                const searchMatch = !searchQuery || 
                                    (t.title && t.title.toLowerCase().includes(searchQuery)) || 
                                    (t.note && t.note.toLowerCase().includes(searchQuery));
                                    
                return clientMatch && statusMatch && searchMatch;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-slate-400">해당하는 업무가 없습니다.</td></tr>`;
                return;
            }

            filtered.forEach(t => {
                const client = clients.find(c => c.id === t.clientId);
                const clientName = t.clientId === 'ALL' ? '공통' : (client ? client.name : 'Unknown');
                const isDone = t.status === 'done';
                const trClass = isDone ? 'bg-slate-50/50' : 'hover:bg-slate-50';
                const titleClass = isDone ? 'text-slate-400 line-through decoration-slate-300' : 'text-slate-800';
                const checkColor = isDone ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300 hover:border-blue-500 text-transparent hover:text-blue-200';
                
                let priorityClass = 'bg-slate-100 text-slate-600';
                if(t.priority === 'High') priorityClass = 'bg-red-50 text-red-700';
                else if(t.priority === 'Medium') priorityClass = 'bg-orange-50 text-orange-700';

                tbody.innerHTML += `
                    <tr class="${trClass} transition-colors group">
                        <td class="px-6 py-4">
                            <button onclick="toggleStatus('${t.id}', '${t.status}')" class="w-5 h-5 rounded border flex items-center justify-center transition-colors ${checkColor}">
                                <i data-lucide="check" class="w-3 h-3"></i>
                            </button>
                        </td>
                        <td class="px-6 py-4 font-medium text-slate-700">${clientName}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium ${titleClass}">${t.title}</div>
                            ${t.note ? `<div class="text-xs text-slate-500 mt-1 flex items-center gap-1"><i data-lucide="file-text" class="w-3 h-3"></i> ${t.note}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 text-slate-500 font-mono text-xs">${t.due || '-'}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${priorityClass}">${t.priority}</span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="openEditTask('${t.id}')" class="text-slate-300 hover:text-blue-500 transition-colors mr-2 opacity-0 group-hover:opacity-100">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteTask('${t.id}')" class="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            lucide.createIcons();
        }

        function renderUrgent() {
            const container = document.getElementById('urgent-grid');
            const section = document.getElementById('urgent-section');
            container.innerHTML = '';
            
            const today = new Date().toISOString().split('T')[0];
            const urgent = tasks.filter(t => {
                if(t.status === 'done' || !t.due) return false;
                const days = Math.ceil((new Date(t.due) - new Date(today)) / (1000 * 60 * 60 * 24));
                return days <= 3;
            });

            if(urgent.length === 0) {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');

            urgent.forEach(t => {
                const client = clients.find(c => c.id === t.clientId);
                const clientName = t.clientId === 'ALL' ? '공통' : (client ? client.name : '-');
                const daysLeft = Math.ceil((new Date(t.due) - new Date(today)) / (1000 * 60 * 60 * 24));

                container.innerHTML += `
                    <div class="bg-red-50 border border-red-100 rounded-xl p-4 shadow-sm relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-red-100 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-bold text-red-600 bg-white px-2 py-0.5 rounded border border-red-100">${clientName}</span>
                                <span class="text-xs font-bold text-red-500">D-${daysLeft}</span>
                            </div>
                            <h4 class="font-bold text-slate-800 mb-1">${t.title}</h4>
                            ${t.note ? `<p class="text-xs text-slate-600 mb-2 bg-white/50 p-1.5 rounded">${t.note}</p>` : ''}
                            <div class="flex justify-between items-center mt-3">
                                <span class="text-xs text-slate-400 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${t.due}</span>
                                <button onclick="toggleStatus('${t.id}', '${t.status}')" class="text-xs bg-white border border-red-200 text-red-600 px-2 py-1 rounded hover:bg-red-600 hover:text-white transition-colors">완료 처리</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        function renderEvents() {
            const list = document.getElementById('event-list');
            list.innerHTML = '';
            
            const sorted = events.sort((a,b) => new Date(a.date) - new Date(b.date));
            const today = new Date().toISOString().split('T')[0];

            sorted.filter(e => new Date(e.date) >= new Date(today)).forEach(e => {
                list.innerHTML += `
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-100">
                        <div class="flex items-start gap-2">
                            <i data-lucide="calendar" class="w-3.5 h-3.5 text-purple-600 mt-0.5"></i>
                            <div>
                                <p class="text-xs font-bold text-purple-800">${e.title}</p>
                                <p class="text-xs text-purple-600 mt-0.5">${e.date} ${e.time || ''}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        function populateClientSelect() {
            const selectTask = document.getElementById('modal-client');
            const selectRoutine = document.getElementById('routine-client');
            const options = `<option value="ALL" class="font-bold">✨ 공통 (General)</option>` + 
                clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            selectTask.innerHTML = options;
            selectRoutine.innerHTML = options;
        }

        window.toggleStatus = async (id, currentStatus) => {
            const next = currentStatus === 'done' ? 'todo' : 'done';
            const updateData = { status: next };
            
            if (next === 'done') {
                updateData.completedAt = new Date().toISOString();
            } else {
                updateData.completedAt = null;
            }
            
            await updateDoc(doc(db, 'pm_users', currentUser.uid, 'tasks', id), updateData);
        };

        window.deleteTask = async (id) => {
            if(confirm("삭제하시겠습니까?")) {
                await deleteDoc(doc(db, 'pm_users', currentUser.uid, 'tasks', id));
            }
        };

        window.saveTask = async () => {
            const id = document.getElementById('modal-task-id').value;
            const clientId = document.getElementById('modal-client').value;
            const title = document.getElementById('modal-title').value;
            const note = document.getElementById('modal-note').value;
            const priority = document.getElementById('modal-priority').value;
            const due = document.getElementById('modal-due').value;

            if(!title) return alert("업무명을 입력하세요");

            if (id) {
                await updateDoc(doc(db, 'pm_users', currentUser.uid, 'tasks', id), {
                    clientId, title, note, priority, due
                });
            } else {
                await addDoc(collection(db, 'pm_users', currentUser.uid, 'tasks'), {
                    clientId, title, note, priority, due, status: 'todo', createdAt: new Date().toISOString()
                });
            }
            closeModal('task-modal');
        };

        window.openAddTaskModal = () => {
            document.getElementById('modal-task-id').value = "";
            document.getElementById('task-modal-title').innerText = "새 업무 추가";
            document.getElementById('modal-save-btn').innerText = "추가하기";
            document.getElementById('modal-client').value = selectedClientId === 'all' ? 'ALL' : selectedClientId;
            document.getElementById('modal-title').value = "";
            document.getElementById('modal-note').value = "";
            document.getElementById('modal-priority').value = "Medium";
            document.getElementById('modal-due').value = "";
            openModal('task-modal');
        };

        window.openEditTask = (id) => {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            document.getElementById('modal-task-id').value = id;
            document.getElementById('task-modal-title').innerText = "업무 수정";
            document.getElementById('modal-save-btn').innerText = "수정 저장";
            document.getElementById('modal-client').value = task.clientId;
            document.getElementById('modal-title').value = task.title;
            document.getElementById('modal-note').value = task.note || "";
            document.getElementById('modal-priority').value = task.priority;
            document.getElementById('modal-due').value = task.due || "";
            openModal('task-modal');
        };

        window.addEvent = async () => {
            const title = document.getElementById('event-title').value;
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;

            if(!title || !date) return alert("일정명과 날짜를 입력하세요");

            const btn = document.getElementById('btn-add-event');
            const originalText = btn.innerText;
            btn.innerText = "⏳ 구글 캘린더 연동 중...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, 'pm_users', currentUser.uid, 'events'), {
                    title, date, time
                });

                const addToGoogleCalendar = httpsCallable(functions, 'addToGoogleCalendar');
                await addToGoogleCalendar({ title, date, time });
                
                alert("대시보드 및 구글 캘린더에 저장되었습니다.");
                closeModal('event-modal');
                document.getElementById('event-title').value = '';
            } catch(error) {
                alert("대시보드엔 저장됐지만, 구글 캘린더 연동 실패: " + error.message);
                closeModal('event-modal');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        window.createReport = async () => {
            const month = document.getElementById('report-month').value;
            const resultDiv = document.getElementById('report-result');
            const btn = document.getElementById('btn-create-report');

            if(!month) return alert("생성할 월을 선택해주세요.");

            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> 생성 중...';
            btn.disabled = true;
            resultDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-full gap-4"><div class="loader"></div><p class="font-medium text-slate-500">Gemini 2.5 Pro가 데이터를 분석 및 구조화하고 있습니다...</p></div>`;
            lucide.createIcons();

            try {
                const generateReport = httpsCallable(functions, 'generateMonthlyReport');
                const response = await generateReport({ 
                    userId: currentUser.uid, 
                    month: month 
                });

                const data = response.data.data;

                let htmlHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
                const groupedArray = Array.isArray(data) ? data : [data];

                groupedArray.forEach(group => {
                    htmlHTML += '<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col hover:shadow-md transition-shadow">';
                    htmlHTML += '<div class="bg-slate-50 px-5 py-4 border-b border-slate-200 flex items-center gap-2">';
                    htmlHTML += '<i data-lucide="building-2" class="w-5 h-5 text-purple-600"></i>';
                    htmlHTML += '<h3 class="text-lg font-bold text-slate-800">' + (group.client_name || '분류 없음') + '</h3>';
                    htmlHTML += '</div>';
                    htmlHTML += '<div class="p-5 flex-1 space-y-4">';

                    const tasks = Array.isArray(group.tasks) ? group.tasks : [];
                    if(tasks.length === 0) {
                        htmlHTML += '<div class="text-center py-6 text-slate-400 bg-slate-50 rounded-lg border border-dashed border-slate-200">완료된 업무가 없습니다.</div>';
                    } else {
                        tasks.forEach(row => {
                            htmlHTML += '<div class="bg-slate-50/50 p-4 rounded-lg border border-slate-100">';
                            htmlHTML += '<h4 class="text-purple-700 font-bold mb-2 flex items-start gap-1.5"><i data-lucide="check-circle-2" class="w-4 h-4 mt-0.5 text-purple-500 flex-shrink-0"></i> [' + (row.item || '항목 없음') + ']</h4>';
                            htmlHTML += '<div class="pl-5 space-y-1.5 text-slate-600">';
                            htmlHTML += '<p><span class="font-semibold text-slate-700">상세내용:</span> ' + (row.details || '') + '</p>';
                            htmlHTML += '<p><span class="font-semibold text-slate-700">대응방안:</span> ' + (row.action_plan || '') + '</p>';
                            htmlHTML += '<p class="text-xs text-slate-400 mt-2 pt-2 border-t border-slate-200"><span class="font-semibold">비고:</span> ' + (row.remarks || '-') + '</p>';
                            htmlHTML += '</div></div>';
                        });
                    }
                    htmlHTML += '</div></div>';
                });
                htmlHTML += '</div>';

                resultDiv.innerHTML = htmlHTML;

            } catch (error) {
                console.error(error);
                resultDiv.innerHTML = `<div class="bg-red-50 p-6 rounded-lg border border-red-200 text-center"><i data-lucide="alert-triangle" class="w-10 h-10 text-red-500 mx-auto mb-2"></i><p class="text-red-700 font-bold text-lg">리포트 생성 실패</p><p class="text-sm text-red-500 mt-1">${error.message}</p></div>`;
            } finally {
                btn.innerHTML = '<i data-lucide="file-output" class="w-4 h-4"></i> 보고서 생성';
                btn.disabled = false;
                lucide.createIcons();
            }
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.openBulkModal = () => {
            document.getElementById('bulk-input-text').value = '';
            document.getElementById('bulk-preview-area').innerHTML = '<div class="h-full flex items-center justify-center text-slate-400 text-sm">텍스트를 붙여넣고 분석을 시작하면, 확인 및 수정 가능한 목록이 여기에 표시됩니다.</div>';
            document.getElementById('btn-save-bulk').classList.add('hidden');
            openModal('bulk-modal');
        };

        let bulkParsedTasks = [];

        window.parseTextWithAI = async () => {
            const text = document.getElementById('bulk-input-text').value;
            if(!text.trim()) return alert("분석할 텍스트를 입력하세요.");

            const btn = document.getElementById('btn-parse-ai');
            const preview = document.getElementById('bulk-preview-area');
            
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> 분석 중...';
            btn.disabled = true;
            preview.innerHTML = '<div class="h-full flex items-center justify-center text-slate-500 text-sm gap-2"><div class="loader"></div>Gemini가 텍스트에서 업무와 고객사를 발라내고 있습니다...</div>';

            const clientString = clients.map(c => c.id + ': ' + c.name).join(', ');

            try {
                const parseFn = httpsCallable(functions, 'parseTasksWithAI');
                const res = await parseFn({ text: text, clientList: clientString });
                bulkParsedTasks = res.data.data;

                if(!Array.isArray(bulkParsedTasks) || bulkParsedTasks.length === 0) {
                    preview.innerHTML = '<div class="text-center text-slate-500 py-10">추출할 업무가 발견되지 않았습니다.</div>';
                    return;
                }

                let html = '';
                bulkParsedTasks.forEach((t, i) => {
                    let options = '<option value="ALL">✨ 공통 (General)</option>';
                    clients.forEach(c => {
                        options += '<option value="' + c.id + '" ' + (c.id === t.clientId ? 'selected' : '') + '>' + c.name + '</option>';
                    });

                    html += '<div class="bg-white p-3 rounded border border-slate-200 flex gap-3 items-start shadow-sm">';
                    html += '<input type="checkbox" id="chk-' + i + '" checked class="mt-2 w-4 h-4 text-emerald-600 rounded">';
                    html += '<div class="flex-1 space-y-2">';
                    html += '<div class="flex gap-2">';
                    html += '<select id="client-' + i + '" class="border border-slate-300 rounded p-1 text-xs bg-slate-50 w-32">' + options + '</select>';
                    html += '<input type="text" id="title-' + i + '" value="' + (t.title || '') + '" class="border border-slate-300 rounded p-1 text-xs flex-1">';
                    html += '</div>';
                    html += '<div class="flex gap-2">';
                    html += '<input type="date" id="due-' + i + '" value="' + (t.due || '') + '" class="border border-slate-300 rounded p-1 text-xs w-32">';
                    html += '<select id="pri-' + i + '" class="border border-slate-300 rounded p-1 text-xs bg-slate-50 w-24"><option value="High" ' + (t.priority === 'High' ? 'selected' : '') + '>High</option><option value="Medium" ' + (t.priority === 'Medium' ? 'selected' : '') + '>Medium</option><option value="Low" ' + (t.priority === 'Low' ? 'selected' : '') + '>Low</option></select>';
                    html += '<input type="text" id="note-' + i + '" value="' + (t.note || '') + '" placeholder="상세 내용 메모" class="border border-slate-300 rounded p-1 text-xs flex-1">';
                    html += '</div></div></div>';
                });

                preview.innerHTML = html;
                document.getElementById('btn-save-bulk').classList.remove('hidden');

            } catch(e) {
                preview.innerHTML = '<div class="text-red-500 p-4">분석 실패: ' + e.message + '</div>';
            } finally {
                btn.innerHTML = '<i data-lucide="wand-2" class="w-4 h-4"></i> 텍스트 분석 시작';
                btn.disabled = false;
                lucide.createIcons();
            }
        };

        window.saveBulkTasks = async () => {
            if(!confirm("선택한 업무들을 대시보드에 등록하시겠습니까?")) return;
            
            const batch = writeBatch(db);
            let count = 0;

            for(let i=0; i<bulkParsedTasks.length; i++) {
                if(document.getElementById('chk-' + i).checked) {
                    const newRef = doc(collection(db, 'pm_users', currentUser.uid, 'tasks'));
                    batch.set(newRef, {
                        clientId: document.getElementById('client-' + i).value,
                        title: document.getElementById('title-' + i).value,
                        due: document.getElementById('due-' + i).value,
                        priority: document.getElementById('pri-' + i).value,
                        note: document.getElementById('note-' + i).value,
                        status: 'todo',
                        createdAt: new Date().toISOString()
                    });
                    count++;
                }
            }

            if(count > 0) {
                await batch.commit();
                alert(count + "개의 업무가 성공적으로 등록되었습니다.");
                closeModal('bulk-modal');
            } else {
                alert("선택된 업무가 없습니다.");
            }
        };

        window.openDailyModal = () => {
            document.getElementById('daily-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('daily-result').innerHTML = '<div class="h-full flex flex-col items-center justify-center text-slate-400 text-sm"><i data-lucide="sun" class="w-12 h-12 mb-3 text-slate-300"></i>기준 일자를 선택하고 생성 버튼을 누르세요.</div>';
            openModal('daily-modal');
        };

        window.createDailyReport = async () => {
            const date = document.getElementById('daily-date').value;
            const resultDiv = document.getElementById('daily-result');
            const btn = document.getElementById('btn-create-daily');

            if(!date) return alert("날짜를 선택해주세요.");

            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> 생성 중...';
            btn.disabled = true;
            resultDiv.innerHTML = '<div class="flex flex-col items-center justify-center h-full gap-4"><div class="loader"></div><p class="font-medium text-slate-500">Gemini가 데일리 브리핑 자료를 작성 중입니다...</p></div>';
            lucide.createIcons();

            try {
                const generateDaily = httpsCallable(functions, 'generateDailyReport');
                const response = await generateDaily({ userId: currentUser.uid, date: date });
                const data = response.data.data;

                let html = '<div class="space-y-4">';
                
                const sections = [
                    { title: '어제 한 일', icon: 'check-circle', color: 'text-green-600', data: data.yesterday_done },
                    { title: '오늘 할 일', icon: 'calendar', color: 'text-blue-600', data: data.today_todo },
                    { title: '정보 공유', icon: 'info', color: 'text-purple-600', data: data.sharing_points },
                    { title: '공조 요청', icon: 'users', color: 'text-orange-600', data: data.cooperation_needed },
                    { title: '시사점 및 리스크', icon: 'alert-triangle', color: 'text-red-600', data: data.insights }
                ];

                sections.forEach(sec => {
                    html += '<div class="bg-white rounded-lg border border-slate-200 p-4 shadow-sm">';
                    html += '<h4 class="font-bold flex items-center gap-2 mb-3 ' + sec.color + '"><i data-lucide="' + sec.icon + '" class="w-5 h-5"></i> ' + sec.title + '</h4>';
                    html += '<ul class="space-y-2 text-sm text-slate-700">';
                    if(Array.isArray(sec.data) && sec.data.length > 0 && sec.data[0] !== "해당 없음") {
                        sec.data.forEach(item => {
                            html += '<li class="flex items-start gap-2"><span class="text-slate-400 mt-0.5">•</span><span>' + item + '</span></li>';
                        });
                    } else {
                        html += '<li class="text-slate-400">해당 없음</li>';
                    }
                    html += '</ul></div>';
                });
                
                html += '</div>';
                resultDiv.innerHTML = html;

            } catch (e) {
                console.error(e);
                resultDiv.innerHTML = '<div class="bg-red-50 p-4 rounded-lg text-red-600">오류 발생: ' + e.message + '</div>';
            } finally {
                btn.innerHTML = '<i data-lucide="file-output" class="w-4 h-4"></i> 생성하기';
                btn.disabled = false;
                lucide.createIcons();
            }
        };
    </script>
</body>
</html>
